# ä¸€æ–‡å¸¦ä½ äº†è§£å¹¶å‘ç¼–ç¨‹ï¼šçº¿ç¨‹ã€è¿›ç¨‹ä¸åç¨‹

åœ¨ Python ä¸­ï¼Œ **å¹¶å‘ç¼–ç¨‹** è®©ç¨‹åºèƒ½å¤ŸåŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œæ˜¾è‘—æé«˜æ•ˆç‡ã€‚ä¸»è¦çš„å¹¶å‘æ–¹æ¡ˆåŒ…æ‹¬ã€å¤šçº¿ç¨‹ã€‘ã€ã€å¤šè¿›ç¨‹ã€‘å’Œã€åç¨‹ã€‘ã€‚æœ¬æ–‡å°†æ·±å…¥æµ…å‡ºåœ°ä»‹ç»è¿™äº›æ¦‚å¿µã€é€‚ç”¨åœºæ™¯ï¼Œå¹¶æä¾›ä¼˜åŒ–åçš„ä»£ç ç¤ºä¾‹ï¼Œå¸®åŠ©ä½ è½»æ¾æŒæ¡å¹¶å‘ç¼–ç¨‹ã€‚

## 1\. è¿›ç¨‹ä¸çº¿ç¨‹åŸºç¡€

### 1.1 è¿›ç¨‹ä¸çº¿ç¨‹çš„å…³ç³»

  *  **è¿›ç¨‹** ï¼šæ“ä½œç³»ç»Ÿèµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼Œæ‹¥æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œå„è¿›ç¨‹ç›¸äº’éš”ç¦»ã€‚
  *  **çº¿ç¨‹** ï¼šCPU è°ƒåº¦çš„æœ€å°æ‰§è¡Œå•ä½ï¼ŒåŒä¸€è¿›ç¨‹å†…çš„å¤šä¸ªçº¿ç¨‹å…±äº«è¯¥è¿›ç¨‹çš„èµ„æºã€‚



ğŸŒŸ **å½¢è±¡æ¯”å–»** ï¼šè¿›ç¨‹å¥½æ¯”ä¸€ä¸ªå·¥å‚ï¼Œçº¿ç¨‹åˆ™æ˜¯å·¥å‚é‡Œçš„å·¥äººã€‚å¤šçº¿ç¨‹å°±åƒå¤šä¸ªå·¥äººåœ¨åŒä¸€å·¥å‚åä½œï¼Œå¤šè¿›ç¨‹åˆ™æ˜¯å¼€è®¾å¤šä¸ªå·¥å‚å¹¶è¡Œå·¥ä½œã€‚

### 1.2 GILï¼ˆå…¨å±€è§£é‡Šå™¨é”ï¼‰

CPython è§£é‡Šå™¨çš„ GIL æœºåˆ¶ä½¿å¾—å³ä½¿å¯ç”¨å¤šçº¿ç¨‹ï¼ŒåŒä¸€æ—¶åˆ»ä¹Ÿåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œ Python å­—èŠ‚ç ã€‚å› æ­¤ï¼š

  *  **è®¡ç®—å¯†é›†å‹ä»»åŠ¡** ï¼ˆå¤§é‡æ•°å­¦è¿ç®—ã€æ•°æ®å¤„ç†ï¼‰æ›´é€‚åˆä½¿ç”¨å¤šè¿›ç¨‹ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸ CPUã€‚
  *  **IO å¯†é›†å‹ä»»åŠ¡** ï¼ˆæ–‡ä»¶è¯»å†™ã€ç½‘ç»œè¯·æ±‚ï¼‰é€‚åˆä½¿ç”¨å¤šçº¿ç¨‹æˆ–åç¨‹ï¼Œå› ä¸ºåœ¨ç­‰å¾… IO æ—¶å¯ä»¥åˆ‡æ¢åˆ°å…¶ä»–ä»»åŠ¡ã€‚



## 2\. å¤šçº¿ç¨‹ç¼–ç¨‹

å¤šçº¿ç¨‹ç‰¹åˆ«é€‚åˆå¤„ç† IO å¯†é›†å‹ä»»åŠ¡ï¼Œä¾‹å¦‚å¹¶è¡Œä¸‹è½½å¤šä¸ªæ–‡ä»¶ã€‚ä¸‹é¢å±•ç¤ºä¸€ä¸ªä¼˜åŒ–çš„å¤šçº¿ç¨‹ä¸‹è½½ç¤ºä¾‹ï¼š
    
          1. importÂ threading
      2. importÂ requests
      3. importÂ time
      4. importÂ logging
      5. fromÂ concurrent.futuresÂ importÂ ThreadPoolExecutor
      6. fromÂ typingÂ importÂ List,Â Tuple
      7. # é…ç½®æ—¥å¿—
      8. logging.basicConfig(
      9. Â  Â  level=logging.INFO,
      10. Â  Â  format='%(asctime)s - %(threadName)s - %(levelname)s - %(message)s'
      11. )
      12. loggerÂ =Â logging.getLogger(__name__)
      13.   14. classÂ DownloadManager:
      15. Â  Â Â """æ–‡ä»¶ä¸‹è½½ç®¡ç†å™¨ï¼Œæ”¯æŒå¤šçº¿ç¨‹å¹¶è¡Œä¸‹è½½"""
      16. Â  Â Â defÂ __init__(self,Â max_workers:Â intÂ =Â 5):
      17. Â  Â  Â  Â Â """
      18. Â  Â  Â  Â  åˆå§‹åŒ–ä¸‹è½½ç®¡ç†å™¨
      19. Â  Â  Â  Â  å‚æ•°:
      20. Â  Â  Â  Â  Â  Â  max_workers: æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°
      21. Â  Â  Â  Â  """
      22. Â  Â  Â  Â  self.max_workersÂ =Â max_workers
      23. Â  Â  Â  Â Â # ä½¿ç”¨çº¿ç¨‹æ± ç®¡ç†çº¿ç¨‹èµ„æº
      24. Â  Â  Â  Â  self.executorÂ =Â ThreadPoolExecutor(max_workers=max_workers,Â thread_name_prefix="Downloader")
      25.   26. Â  Â Â defÂ download_file(self,Â file_name:Â str,Â url:Â str,Â timeout:Â intÂ =Â 30)Â ->Â bool:
      27. Â  Â  Â  Â Â """
      28. Â  Â  Â  Â  ä¸‹è½½å•ä¸ªæ–‡ä»¶çš„æ–¹æ³•
      29.   30. Â  Â  Â  Â  å‚æ•°:
      31. Â  Â  Â  Â  Â  Â  file_name: ä¿å­˜çš„æ–‡ä»¶å
      32. Â  Â  Â  Â  Â  Â  url: ä¸‹è½½æ–‡ä»¶çš„URLåœ°å€
      33. Â  Â  Â  Â  Â  Â  timeout: è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
      34. Â  Â  Â  Â  è¿”å›:
      35. Â  Â  Â  Â  Â  Â  bool: ä¸‹è½½æ˜¯å¦æˆåŠŸ
      36. Â  Â  Â  Â  """
      37. Â  Â  Â  Â Â try:
      38. Â  Â  Â  Â  Â  Â  logger.info(f"å¼€å§‹ä¸‹è½½ {file_name}")
      39. Â  Â  Â  Â  Â  Â  start_timeÂ =Â time.time()
      40.   41. Â  Â  Â  Â  Â  Â Â # æ·»åŠ è¯·æ±‚å¤´æ¨¡æ‹Ÿæµè§ˆå™¨è¡Œä¸º
      42. Â  Â  Â  Â  Â  Â  headersÂ =Â {
      43. Â  Â  Â  Â  Â  Â  Â  Â Â 'User-Agent':Â 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
      44. Â  Â  Â  Â  Â  Â Â }
      45. Â  Â  Â  Â  Â  Â Â # ä½¿ç”¨è¶…æ—¶å’Œæµå¼ä¸‹è½½å¤„ç†å¤§æ–‡ä»¶
      46. Â  Â  Â  Â  Â  Â Â withÂ requests.get(url,Â headers=headers,Â stream=True,Â timeout=timeout)Â asÂ response:
      47. Â  Â  Â  Â  Â  Â  Â  Â  response.raise_for_status()Â Â # ç¡®ä¿è¯·æ±‚æˆåŠŸ
      48. Â  Â  Â  Â  Â  Â  Â  Â Â # è·å–æ–‡ä»¶å¤§å°ï¼ˆå¦‚æœæœåŠ¡å™¨æä¾›ï¼‰
      49. Â  Â  Â  Â  Â  Â  Â  Â  total_sizeÂ =Â int(response.headers.get('content-length',Â 0))
      50.   51. Â  Â  Â  Â  Â  Â  Â  Â Â withÂ open(file_name,Â 'wb')Â asÂ f:
      52. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â # åˆ†å—ä¸‹è½½ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§æ–‡ä»¶åˆ°å†…å­˜
      53. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chunk_sizeÂ =Â 8192Â Â # 8KB
      54. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadedÂ =Â 0
      55. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â forÂ chunkÂ inÂ response.iter_content(chunk_size=chunk_size):
      56. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â ifÂ chunk:Â Â # è¿‡æ»¤ä¿æŒè¿æ¥æ´»è·ƒçš„ç©ºå—
      57. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  f.write(chunk)
      58. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadedÂ +=Â len(chunk)
      59.   60. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â # è®°å½•ä¸‹è½½è¿›åº¦
      61. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â ifÂ total_sizeÂ >Â 0:
      62. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progressÂ =Â (downloadedÂ /Â total_size)Â *Â 100
      63. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â ifÂ downloadedÂ %Â (5Â *Â chunk_size)Â ==Â 0:Â Â # æ¯ä¸‹è½½çº¦40KBæ›´æ–°ä¸€æ¬¡è¿›åº¦
      64. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logger.debug(f"{file_name} - ä¸‹è½½è¿›åº¦: {progress:.1f}%")
      65.   66. Â  Â  Â  Â  Â  Â  elapsedÂ =Â time.time()Â -Â start_time
      67. Â  Â  Â  Â  Â  Â  logger.info(f"{file_name} ä¸‹è½½å®Œæˆ - è€—æ—¶: {elapsed:.2f}ç§’")
      68. Â  Â  Â  Â  Â  Â Â returnÂ True
      69.   70. Â  Â  Â  Â Â exceptÂ requests.exceptions.RequestExceptionÂ asÂ e:
      71. Â  Â  Â  Â  Â  Â  logger.error(f"ä¸‹è½½ {file_name} å¤±è´¥: {str(e)}")
      72. Â  Â  Â  Â  Â  Â Â returnÂ False
      73. Â  Â  Â  Â Â exceptÂ IOErrorÂ asÂ e:
      74. Â  Â  Â  Â  Â  Â  logger.error(f"æ–‡ä»¶å¤„ç†é”™è¯¯ {file_name}: {str(e)}")
      75. Â  Â  Â  Â  Â  Â Â returnÂ False
      76. Â  Â  Â  Â Â exceptÂ ExceptionÂ asÂ e:
      77. Â  Â  Â  Â  Â  Â  logger.error(f"ä¸‹è½½ {file_name} æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯: {str(e)}")
      78. Â  Â  Â  Â  Â  Â Â returnÂ False
      79.   80. Â  Â Â defÂ download_multiple(self,Â url_list:Â List[Tuple[str,Â str]])Â ->Â List[bool]:
      81. Â  Â  Â  Â Â """
      82. Â  Â  Â  Â  å¹¶è¡Œä¸‹è½½å¤šä¸ªæ–‡ä»¶
      83.   84. Â  Â  Â  Â  å‚æ•°:
      85. Â  Â  Â  Â  Â  Â  url_list: åŒ…å«(æ–‡ä»¶å, URL)å…ƒç»„çš„åˆ—è¡¨
      86. Â  Â  Â  Â  è¿”å›:
      87. Â  Â  Â  Â  Â  Â  List[bool]: æ¯ä¸ªä¸‹è½½ä»»åŠ¡çš„æˆåŠŸçŠ¶æ€åˆ—è¡¨
      88. Â  Â  Â  Â  """
      89. Â  Â  Â  Â  logger.info(f"å¼€å§‹ä¸‹è½½ {len(url_list)} ä¸ªæ–‡ä»¶ï¼Œä½¿ç”¨ {self.max_workers} ä¸ªçº¿ç¨‹")
      90.   91. Â  Â  Â  Â Â # æäº¤æ‰€æœ‰ä¸‹è½½ä»»åŠ¡åˆ°çº¿ç¨‹æ± 
      92. Â  Â  Â  Â  futuresÂ =Â [
      93. Â  Â  Â  Â  Â  Â  self.executor.submit(self.download_file,Â file_name,Â url)
      94. Â  Â  Â  Â  Â  Â Â forÂ file_name,Â urlÂ inÂ url_list
      95. Â  Â  Â  Â Â ]
      96.   97. Â  Â  Â  Â Â # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆå¹¶æ”¶é›†ç»“æœ
      98. Â  Â  Â  Â  resultsÂ =Â []
      99. Â  Â  Â  Â Â forÂ futureÂ inÂ futures:
      100. Â  Â  Â  Â  Â  Â Â try:
      101. Â  Â  Â  Â  Â  Â  Â  Â  resultÂ =Â future.result()
      102. Â  Â  Â  Â  Â  Â  Â  Â  results.append(result)
      103. Â  Â  Â  Â  Â  Â Â exceptÂ ExceptionÂ asÂ e:
      104. Â  Â  Â  Â  Â  Â  Â  Â  logger.error(f"æ‰§è¡Œä»»åŠ¡æ—¶å‘ç”Ÿå¼‚å¸¸: {str(e)}")
      105. Â  Â  Â  Â  Â  Â  Â  Â  results.append(False)
      106.   107. Â  Â  Â  Â Â # ç»Ÿè®¡æˆåŠŸç‡
      108. Â  Â  Â  Â  success_countÂ =Â sum(results)
      109. Â  Â  Â  Â  logger.info(f"æ‰€æœ‰ä¸‹è½½ä»»åŠ¡å®Œæˆ! æˆåŠŸ: {success_count}/{len(url_list)}")
      110.   111. Â  Â  Â  Â Â returnÂ results
      112.   113. Â  Â Â defÂ shutdown(self):
      114. Â  Â  Â  Â Â """å…³é—­çº¿ç¨‹æ± ï¼Œé‡Šæ”¾èµ„æº"""
      115. Â  Â  Â  Â  self.executor.shutdown(wait=True)
      116. Â  Â  Â  Â  logger.info("ä¸‹è½½ç®¡ç†å™¨å·²å…³é—­")
      117.   118. # ä½¿ç”¨ç¤ºä¾‹
      119. ifÂ __name__Â ==Â "__main__":
      120. Â  Â Â # æµ‹è¯•URLåˆ—è¡¨ (æ›¿æ¢ä¸ºå®é™…å¯ç”¨çš„URL)
      121. Â  Â  url_listÂ =Â [
      122. Â  Â  Â  Â Â ("video1.mp4",Â "https://example.com/video1"),
      123. Â  Â  Â  Â Â ("video2.mp4",Â "https://example.com/video2"),
      124. Â  Â  Â  Â Â ("video3.mp4",Â "https://example.com/video3")
      125. Â  Â Â ]
      126. Â  Â Â # åˆ›å»ºä¸‹è½½ç®¡ç†å™¨å¹¶å¼€å§‹ä¸‹è½½
      127. Â  Â  downloaderÂ =Â DownloadManager(max_workers=3)
      128. Â  Â Â try:
      129. Â  Â  Â  Â  resultsÂ =Â downloader.download_multiple(url_list)
      130. Â  Â Â finally:
      131. Â  Â  Â  Â Â # ç¡®ä¿èµ„æºè¢«æ­£ç¡®é‡Šæ”¾
      132. Â  Â  Â  Â  downloader.shutdown()
    
    

### çº¿ç¨‹ç®¡ç†çš„å…³é”®ç‚¹

  *  **çº¿ç¨‹æ± ** ï¼šä½¿ç”¨ `ThreadPoolExecutor` ç®¡ç†çº¿ç¨‹èµ„æºï¼Œé¿å…é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„å¼€é”€ã€‚
  *  **å¼‚å¸¸å¤„ç†** ï¼šå¯¹æ¯ä¸ªä¸‹è½½ä»»åŠ¡è¿›è¡Œå®Œå–„çš„å¼‚å¸¸å¤„ç†ï¼Œç¡®ä¿å•ä¸ªä»»åŠ¡å¤±è´¥ä¸ä¼šå½±å“æ•´ä½“ç¨‹åºã€‚
  *  **èµ„æºç®¡ç†** ï¼šé€šè¿‡ `with` è¯­å¥å’Œ `shutdown()` æ–¹æ³•ç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾ã€‚
  *  **æ—¥å¿—è®°å½•** ï¼šä½¿ç”¨ `logging` æ¨¡å—æ›¿ä»£ç®€å•çš„ `print`ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œé—®é¢˜è¿½è¸ªã€‚



### çº¿ç¨‹é”ä¿è¯æ•°æ®å®‰å…¨

å½“å¤šä¸ªçº¿ç¨‹æ“ä½œå…±äº«æ•°æ®æ—¶ï¼Œéœ€è¦ä½¿ç”¨é”æœºåˆ¶é˜²æ­¢æ•°æ®ç«äº‰é—®é¢˜ï¼š
    
          1. importÂ threading
      2. importÂ logging
      3. importÂ time
      4. fromÂ typingÂ importÂ List
      5. # é…ç½®æ—¥å¿—
      6. logging.basicConfig(
      7. Â  Â  level=logging.INFO,
      8. Â  Â  format='%(asctime)s - %(threadName)s - %(levelname)s - %(message)s'
      9. )
      10. loggerÂ =Â logging.getLogger(__name__)
      11.   12. classÂ ThreadSafeCounter:
      13. Â  Â Â """çº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨å®ç°"""
      14. Â  Â Â defÂ __init__(self,Â initial_value:Â intÂ =Â 0):
      15. Â  Â  Â  Â Â """
      16. Â  Â  Â  Â  åˆå§‹åŒ–è®¡æ•°å™¨
      17. Â  Â  Â  Â  å‚æ•°:
      18. Â  Â  Â  Â  Â  Â  initial_value: è®¡æ•°å™¨åˆå§‹å€¼
      19. Â  Â  Â  Â  """
      20. Â  Â  Â  Â  self._valueÂ =Â initial_value
      21. Â  Â  Â  Â  self._lockÂ =Â threading.RLock()Â Â # å¯é‡å…¥é”ï¼Œæ”¯æŒåŒä¸€çº¿ç¨‹å¤šæ¬¡è·å–
      22. Â  Â Â defÂ increment(self,Â amount:Â intÂ =Â 1)Â ->Â int:
      23. Â  Â  Â  Â Â """
      24. Â  Â  Â  Â  å¢åŠ è®¡æ•°å™¨å€¼å¹¶è¿”å›æ–°å€¼
      25. Â  Â  Â  Â  å‚æ•°:
      26. Â  Â  Â  Â  Â  Â  amount: å¢åŠ çš„æ•°é‡
      27.   28. Â  Â  Â  Â  è¿”å›:
      29. Â  Â  Â  Â  Â  Â  int: å¢åŠ åçš„è®¡æ•°å™¨å€¼
      30. Â  Â  Â  Â  """
      31. Â  Â  Â  Â Â withÂ self._lock:
      32. Â  Â  Â  Â  Â  Â  self._valueÂ +=Â amount
      33. Â  Â  Â  Â  Â  Â  currentÂ =Â self._value
      34. Â  Â  Â  Â Â returnÂ current
      35.   36. Â  Â Â defÂ decrement(self,Â amount:Â intÂ =Â 1)Â ->Â int:
      37. Â  Â  Â  Â Â """
      38. Â  Â  Â  Â  å‡å°‘è®¡æ•°å™¨å€¼å¹¶è¿”å›æ–°å€¼
      39.   40. Â  Â  Â  Â  å‚æ•°:
      41. Â  Â  Â  Â  Â  Â  amount: å‡å°‘çš„æ•°é‡
      42. Â  Â  Â  Â  è¿”å›:
      43. Â  Â  Â  Â  Â  Â  int: å‡å°‘åçš„è®¡æ•°å™¨å€¼
      44. Â  Â  Â  Â  """
      45. Â  Â  Â  Â Â withÂ self._lock:
      46. Â  Â  Â  Â  Â  Â  self._valueÂ -=Â amount
      47. Â  Â  Â  Â  Â  Â  currentÂ =Â self._value
      48. Â  Â  Â  Â Â returnÂ current
      49. Â  Â Â @property
      50. Â  Â Â defÂ value(self)Â ->Â int:
      51. Â  Â  Â  Â Â """
      52. Â  Â  Â  Â  è·å–å½“å‰è®¡æ•°å™¨å€¼
      53.   54. Â  Â  Â  Â  è¿”å›:
      55. Â  Â  Â  Â  Â  Â  int: å½“å‰è®¡æ•°å™¨å€¼
      56. Â  Â  Â  Â  """
      57. Â  Â  Â  Â Â withÂ self._lock:
      58. Â  Â  Â  Â  Â  Â Â returnÂ self._value
      59.   60. defÂ worker(counter:Â ThreadSafeCounter,Â iterations:Â int,Â worker_id:Â int):
      61. Â  Â Â """
      62. Â  Â  å·¥ä½œçº¿ç¨‹å‡½æ•°ï¼Œæ‰§è¡ŒæŒ‡å®šæ¬¡æ•°çš„è®¡æ•°å™¨å¢åŠ æ“ä½œ
      63. Â  Â  å‚æ•°:
      64. Â  Â  Â  Â  counter: çº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨å¯¹è±¡
      65. Â  Â  Â  Â  iterations: è¿­ä»£æ¬¡æ•°
      66. Â  Â  Â  Â  worker_id: å·¥ä½œçº¿ç¨‹ID
      67. Â  Â  """
      68. Â  Â  logger.info(f"å·¥ä½œçº¿ç¨‹ {worker_id} å¼€å§‹æ‰§è¡Œ")
      69.   70. Â  Â Â forÂ iÂ inÂ range(iterations):
      71. Â  Â  Â  Â Â # æ¨¡æ‹Ÿä¸€äº›éšæœºå·¥ä½œé‡
      72. Â  Â  Â  Â Â ifÂ iÂ %Â 10000Â ==Â 0:
      73. Â  Â  Â  Â  Â  Â  logger.debug(f"å·¥ä½œçº¿ç¨‹ {worker_id} å·²å®Œæˆ {i} æ¬¡æ“ä½œ")
      74. Â  Â  Â  Â Â # å¢åŠ è®¡æ•°å™¨
      75. Â  Â  Â  Â  counter.increment()
      76.   77. Â  Â  logger.info(f"å·¥ä½œçº¿ç¨‹ {worker_id} å®Œæˆï¼Œå…±æ‰§è¡Œ {iterations} æ¬¡æ“ä½œ")
      78.   79. defÂ run_threaded_counter_test(num_threads:Â intÂ =Â 5,Â iterations_per_thread:Â intÂ =Â 100000):
      80. Â  Â Â """
      81. Â  Â  è¿è¡Œå¤šçº¿ç¨‹è®¡æ•°å™¨æµ‹è¯•
      82. Â  Â  å‚æ•°:
      83. Â  Â  Â  Â  num_threads: çº¿ç¨‹æ•°é‡
      84. Â  Â  Â  Â  iterations_per_thread: æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œçš„è¿­ä»£æ¬¡æ•°
      85. Â  Â  """
      86. Â  Â Â # åˆ›å»ºçº¿ç¨‹å®‰å…¨è®¡æ•°å™¨
      87. Â  Â  counterÂ =Â ThreadSafeCounter()
      88.   89. Â  Â Â # åˆ›å»ºçº¿ç¨‹åˆ—è¡¨
      90. Â  Â  threads:Â List[threading.Thread]Â =Â []
      91. Â  Â  logger.info(f"å¼€å§‹æµ‹è¯•: {num_threads} ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ {iterations_per_thread} æ¬¡æ“ä½œ")
      92. Â  Â  start_timeÂ =Â time.time()
      93.   94. Â  Â Â # åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰çº¿ç¨‹
      95. Â  Â Â forÂ iÂ inÂ range(num_threads):
      96. Â  Â  Â  Â  tÂ =Â threading.Thread(
      97. Â  Â  Â  Â  Â  Â  target=worker,
      98. Â  Â  Â  Â  Â  Â  args=(counter,Â iterations_per_thread,Â i),
      99. Â  Â  Â  Â  Â  Â  name=f"Worker-{i}"
      100. Â  Â  Â  Â Â )
      101. Â  Â  Â  Â  threads.append(t)
      102. Â  Â  Â  Â  t.start()
      103.   104. Â  Â Â # ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
      105. Â  Â Â forÂ tÂ inÂ threads:
      106. Â  Â  Â  Â  t.join()
      107.   108. Â  Â  elapsedÂ =Â time.time()Â -Â start_time
      109.   110. Â  Â Â # éªŒè¯ç»“æœ
      111. Â  Â  expectedÂ =Â num_threadsÂ *Â iterations_per_thread
      112. Â  Â  actualÂ =Â counter.value
      113.   114. Â  Â  logger.info(f"æµ‹è¯•å®Œæˆ! è€—æ—¶: {elapsed:.2f}ç§’")
      115. Â  Â  logger.info(f"è®¡æ•°å™¨æœ€ç»ˆå€¼: {actual}")
      116. Â  Â  logger.info(f"æœŸæœ›å€¼: {expected}")
      117. Â  Â  logger.info(f"ç»“æœ{'æ­£ç¡®' if actual == expected else 'ä¸æ­£ç¡®'}")
      118.   119. ifÂ __name__Â ==Â "__main__":
      120. Â  Â  run_threaded_counter_test(num_threads=5,Â iterations_per_thread=100000)
    
    

## 3\. å¤šè¿›ç¨‹ç¼–ç¨‹

å¤šè¿›ç¨‹èƒ½å¤Ÿç»•è¿‡ GIL é™åˆ¶ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸ CPUï¼Œç‰¹åˆ«é€‚åˆè®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªä¼˜åŒ–çš„å¤šè¿›ç¨‹è®¡ç®—ç¤ºä¾‹ï¼š
    
          1. importÂ multiprocessingÂ asÂ mp
      2. importÂ time
      3. importÂ logging
      4. importÂ os
      5. importÂ math
      6. fromÂ typingÂ importÂ List,Â Tuple,Â Dict,Â Any
      7. # é…ç½®æ—¥å¿—
      8. logging.basicConfig(
      9. Â  Â  level=logging.INFO,
      10. Â  Â  format='%(asctime)s - %(processName)s - %(levelname)s - %(message)s'
      11. )
      12. loggerÂ =Â logging.getLogger(__name__)
      13.   14. classÂ ParallelProcessor:
      15. Â  Â Â """å¹¶è¡Œä»»åŠ¡å¤„ç†å™¨ï¼ŒåŸºäºå¤šè¿›ç¨‹å®ç°"""
      16. Â  Â Â defÂ __init__(self,Â num_processes:Â intÂ =Â None):
      17. Â  Â  Â  Â Â """
      18. Â  Â  Â  Â  åˆå§‹åŒ–å¹¶è¡Œå¤„ç†å™¨
      19. Â  Â  Â  Â  å‚æ•°:
      20. Â  Â  Â  Â  Â  Â  num_processes: è¿›ç¨‹æ•°é‡ï¼Œé»˜è®¤ä¸ºCPUæ ¸å¿ƒæ•°
      21. Â  Â  Â  Â  """
      22. Â  Â  Â  Â Â # è‹¥æœªæŒ‡å®šè¿›ç¨‹æ•°ï¼Œåˆ™ä½¿ç”¨CPUæ ¸å¿ƒæ•°
      23. Â  Â  Â  Â  self.num_processesÂ =Â num_processesÂ orÂ mp.cpu_count()
      24. Â  Â  Â  Â  logger.info(f"åˆå§‹åŒ–å¹¶è¡Œå¤„ç†å™¨ï¼Œä½¿ç”¨ {self.num_processes} ä¸ªè¿›ç¨‹")
      25.   26. Â  Â Â defÂ _worker_calc_partial_sum(self,Â task_id:Â int,Â start:Â int,Â end:Â int,Â 
      27. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result_queue:Â mp.Queue)Â ->Â None:
      28. Â  Â  Â  Â Â """
      29. Â  Â  Â  Â  å·¥ä½œè¿›ç¨‹å‡½æ•°ï¼šè®¡ç®—éƒ¨åˆ†å’Œ
      30. Â  Â  Â  Â  å‚æ•°:
      31. Â  Â  Â  Â  Â  Â  task_id: ä»»åŠ¡ID
      32. Â  Â  Â  Â  Â  Â  start: èµ·å§‹å€¼ï¼ˆåŒ…å«ï¼‰
      33. Â  Â  Â  Â  Â  Â  end: ç»“æŸå€¼ï¼ˆä¸åŒ…å«ï¼‰
      34. Â  Â  Â  Â  Â  Â  result_queue: ç»“æœé˜Ÿåˆ—
      35. Â  Â  Â  Â  """
      36. Â  Â  Â  Â Â try:
      37. Â  Â  Â  Â  Â  Â  process_idÂ =Â os.getpid()
      38. Â  Â  Â  Â  Â  Â  logger.info(f"ä»»åŠ¡ {task_id} å¼€å§‹äºè¿›ç¨‹ {process_id}ï¼Œè®¡ç®—èŒƒå›´: [{start}, {end})")
      39. Â  Â  Â  Â  Â  Â Â # ç”¨æ•°å­¦å…¬å¼è®¡ç®—åŒºé—´å’Œï¼Œæ¯”å¾ªç¯æ›´é«˜æ•ˆ
      40. Â  Â  Â  Â  Â  Â Â # sum(range(start, end)) = (end-1 + start) * (end - start) / 2
      41. Â  Â  Â  Â  Â  Â  resultÂ =Â (endÂ -Â 1Â +Â start)Â *Â (endÂ -Â start)Â //Â 2
      42. Â  Â  Â  Â  Â  Â Â # ä¹Ÿå¯ä»¥ç”¨å†…ç½®sumå‡½æ•°ï¼Œä½†åœ¨ç‰¹å¤§èŒƒå›´æ—¶å¯èƒ½æ•ˆç‡è¾ƒä½
      43. Â  Â  Â  Â  Â  Â Â # result = sum(range(start, end))
      44.   45. Â  Â  Â  Â  Â  Â Â # å°†ç»“æœæ”¾å…¥é˜Ÿåˆ—
      46. Â  Â  Â  Â  Â  Â  result_queue.put((task_id,Â result))
      47. Â  Â  Â  Â  Â  Â  logger.info(f"ä»»åŠ¡ {task_id} å®Œæˆï¼Œç»“æœ: {result}")
      48.   49. Â  Â  Â  Â Â exceptÂ ExceptionÂ asÂ e:
      50. Â  Â  Â  Â  Â  Â  logger.error(f"ä»»åŠ¡ {task_id} å‡ºé”™: {str(e)}")
      51. Â  Â  Â  Â  Â  Â Â # æ”¾å…¥é”™è¯¯ç»“æœ
      52. Â  Â  Â  Â  Â  Â  result_queue.put((task_id,Â None))
      53. Â  Â Â defÂ calculate_sum(self,Â start:Â int,Â end:Â int)Â ->Â int:
      54. Â  Â  Â  Â Â """
      55. Â  Â  Â  Â  å¹¶è¡Œè®¡ç®—ä»startåˆ°end-1çš„æ•´æ•°å’Œ
      56. Â  Â  Â  Â  å‚æ•°:
      57. Â  Â  Â  Â  Â  Â  start: èµ·å§‹å€¼ï¼ˆåŒ…å«ï¼‰
      58. Â  Â  Â  Â  Â  Â  end: ç»“æŸå€¼ï¼ˆä¸åŒ…å«ï¼‰
      59. Â  Â  Â  Â  è¿”å›:
      60. Â  Â  Â  Â  Â  Â  int: è®¡ç®—ç»“æœ
      61. Â  Â  Â  Â  """
      62. Â  Â  Â  Â Â ifÂ endÂ <=Â start:
      63. Â  Â  Â  Â  Â  Â Â returnÂ 0
      64. Â  Â  Â  Â Â # åˆ›å»ºé€šä¿¡é˜Ÿåˆ—
      65. Â  Â  Â  Â  result_queueÂ =Â mp.Queue()
      66.   67. Â  Â  Â  Â Â # è®¡ç®—æ¯ä¸ªè¿›ç¨‹çš„å·¥ä½œé‡
      68. Â  Â  Â  Â  total_rangeÂ =Â endÂ -Â start
      69. Â  Â  Â  Â  chunk_sizeÂ =Â math.ceil(total_rangeÂ /Â self.num_processes)
      70.   71. Â  Â  Â  Â Â # åˆ›å»ºè¿›ç¨‹åˆ—è¡¨
      72. Â  Â  Â  Â  processesÂ =Â []
      73. Â  Â  Â  Â  logger.info(f"å¼€å§‹è®¡ç®—ä» {start} åˆ° {end-1} çš„å’Œï¼Œåˆ†ä¸º {self.num_processes} ä¸ªå­ä»»åŠ¡")
      74. Â  Â  Â  Â  start_timeÂ =Â time.time()
      75.   76. Â  Â  Â  Â Â # åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰è¿›ç¨‹
      77. Â  Â  Â  Â Â forÂ iÂ inÂ range(self.num_processes):
      78. Â  Â  Â  Â  Â  Â  task_startÂ =Â startÂ +Â iÂ *Â chunk_size
      79. Â  Â  Â  Â  Â  Â  task_endÂ =Â min(task_startÂ +Â chunk_size,Â end)
      80. Â  Â  Â  Â  Â  Â Â # è‹¥å·²è¶…å‡ºèŒƒå›´ï¼Œè·³è¿‡åˆ›å»ºè¿›ç¨‹
      81. Â  Â  Â  Â  Â  Â Â ifÂ task_startÂ >=Â end:
      82. Â  Â  Â  Â  Â  Â  Â  Â Â continue
      83. Â  Â  Â  Â  Â  Â  pÂ =Â mp.Process(
      84. Â  Â  Â  Â  Â  Â  Â  Â  target=self._worker_calc_partial_sum,
      85. Â  Â  Â  Â  Â  Â  Â  Â  args=(i,Â task_start,Â task_end,Â result_queue),
      86. Â  Â  Â  Â  Â  Â  Â  Â  name=f"Calculator-{i}"
      87. Â  Â  Â  Â  Â  Â Â )
      88. Â  Â  Â  Â  Â  Â  processes.append(p)
      89. Â  Â  Â  Â  Â  Â  p.start()
      90. Â  Â  Â  Â Â # æ”¶é›†ç»“æœ
      91. Â  Â  Â  Â  resultsÂ =Â {}
      92. Â  Â  Â  Â Â forÂ _Â inÂ range(len(processes)):
      93. Â  Â  Â  Â  Â  Â  task_id,Â valueÂ =Â result_queue.get()
      94. Â  Â  Â  Â  Â  Â Â ifÂ valueÂ isÂ notÂ None:
      95. Â  Â  Â  Â  Â  Â  Â  Â  results[task_id]Â =Â value
      96.   97. Â  Â  Â  Â Â # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹ç»“æŸ
      98. Â  Â  Â  Â Â forÂ pÂ inÂ processes:
      99. Â  Â  Â  Â  Â  Â  p.join()
      100.   101. Â  Â  Â  Â Â # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ä»»åŠ¡éƒ½æˆåŠŸå®Œæˆ
      102. Â  Â  Â  Â Â ifÂ len(results)Â !=Â len(processes):
      103. Â  Â  Â  Â  Â  Â  logger.warning(f"éƒ¨åˆ†ä»»åŠ¡å¤±è´¥! åªæ”¶åˆ° {len(results)}/{len(processes)} ä¸ªç»“æœ")
      104.   105. Â  Â  Â  Â Â # è®¡ç®—æ€»å’Œ
      106. Â  Â  Â  Â  total_sumÂ =Â sum(results.values())
      107. Â  Â  Â  Â  elapsedÂ =Â time.time()Â -Â start_time
      108. Â  Â  Â  Â  logger.info(f"è®¡ç®—å®Œæˆ! è€—æ—¶: {elapsed:.2f}ç§’")
      109. Â  Â  Â  Â  logger.info(f"ç»“æœ: {total_sum}")
      110. Â  Â  Â  Â Â returnÂ total_sum
      111.   112. # éªŒè¯å‡½æ•°ï¼Œç¡®è®¤å¹¶è¡Œè®¡ç®—ç»“æœæ­£ç¡®æ€§
      113. defÂ verify_sum(start:Â int,Â end:Â int,Â result:Â int)Â ->Â bool:
      114. Â  Â Â """éªŒè¯è®¡ç®—ç»“æœæ˜¯å¦æ­£ç¡®"""
      115. Â  Â Â # ä½¿ç”¨æ•°å­¦å…¬å¼è®¡ç®—æ­£ç¡®ç­”æ¡ˆ
      116. Â  Â  expectedÂ =Â (endÂ -Â 1Â +Â start)Â *Â (endÂ -Â start)Â //Â 2
      117. Â  Â  logger.info(f"éªŒè¯ç»“æœ - è®¡ç®—å€¼: {result}, æœŸæœ›å€¼: {expected}")
      118. Â  Â Â returnÂ resultÂ ==Â expected
      119.   120. ifÂ __name__Â ==Â "__main__":
      121. Â  Â Â # è®¡ç®—ä»0åˆ°1äº¿çš„å’Œ
      122. Â  Â  STARTÂ =Â 0
      123. Â  Â  ENDÂ =Â 100_000_000
      124.   125. Â  Â  processorÂ =Â ParallelProcessor()
      126. Â  Â  resultÂ =Â processor.calculate_sum(START,Â END)
      127. Â  Â Â # éªŒè¯ç»“æœ
      128. Â  Â  is_correctÂ =Â verify_sum(START,Â END,Â result)
      129. Â  Â Â print(f"\nè®¡ç®—ç»“æœ: {result}")
      130. Â  Â Â print(f"ç»“æœéªŒè¯: {'âœ“ æ­£ç¡®' if is_correct else 'âœ— é”™è¯¯'}")
    
    

### è¿›ç¨‹é—´æ•°æ®å…±äº«

ä¸åŒè¿›ç¨‹é—´å†…å­˜ç©ºé—´éš”ç¦»ï¼Œæ•°æ®ä¸èƒ½ç›´æ¥å…±äº«ã€‚å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°å…±äº«ï¼š
    
          1. importÂ multiprocessingÂ asÂ mp
      2. importÂ logging
      3. importÂ time
      4. fromÂ typingÂ importÂ Dict,Â List,Â Any
      5. # é…ç½®æ—¥å¿—
      6. logging.basicConfig(
      7. Â  Â  level=logging.INFO,
      8. Â  Â  format='%(asctime)s - %(processName)s - %(levelname)s - %(message)s'
      9. )
      10. loggerÂ =Â logging.getLogger(__name__)
      11.   12. classÂ SharedDataProcessor:
      13. Â  Â Â """æ¼”ç¤ºå¤šè¿›ç¨‹é—´æ•°æ®å…±äº«çš„å¤„ç†å™¨"""
      14. Â  Â Â defÂ __init__(self):
      15. Â  Â  Â  Â Â """åˆå§‹åŒ–å¤„ç†å™¨"""
      16. Â  Â  Â  Â  logger.info("åˆå§‹åŒ–å…±äº«æ•°æ®å¤„ç†å™¨")
      17. Â  Â Â defÂ using_value_and_array(self):
      18. Â  Â  Â  Â Â """ä½¿ç”¨å…±äº«å†…å­˜Valueå’ŒArrayç¤ºä¾‹"""
      19. Â  Â  Â  Â Â # åˆ›å»ºå…±äº«æ•´æ•°å’Œæ•°ç»„
      20. Â  Â  Â  Â  shared_counterÂ =Â mp.Value('i',Â 0)Â Â # 'i'è¡¨ç¤ºæœ‰ç¬¦å·æ•´æ•°
      21. Â  Â  Â  Â  shared_arrayÂ =Â mp.Array('d',Â [0.0]Â *Â 5)Â Â # 'd'è¡¨ç¤ºåŒç²¾åº¦æµ®ç‚¹æ•°
      22. Â  Â  Â  Â  processesÂ =Â []
      23. Â  Â  Â  Â Â # å®šä¹‰å·¥ä½œå‡½æ•°
      24. Â  Â  Â  Â Â defÂ worker(counter,Â array,Â worker_id):
      25. Â  Â  Â  Â  Â  Â  pidÂ =Â mp.current_process().pid
      26. Â  Â  Â  Â  Â  Â  logger.info(f"å·¥ä½œè¿›ç¨‹ {worker_id} (PID: {pid}) å¼€å§‹")
      27.   28. Â  Â  Â  Â  Â  Â Â # ä¿®æ”¹å…±äº«è®¡æ•°å™¨
      29. Â  Â  Â  Â  Â  Â Â withÂ counter.get_lock():
      30. Â  Â  Â  Â  Â  Â  Â  Â  counter.valueÂ +=Â 1
      31. Â  Â  Â  Â  Â  Â  Â  Â  logger.info(f"å·¥ä½œè¿›ç¨‹ {worker_id} å¢åŠ è®¡æ•°å™¨å€¼åˆ° {counter.value}")
      32. Â  Â  Â  Â  Â  Â Â # ä¿®æ”¹å…±äº«æ•°ç»„
      33. Â  Â  Â  Â  Â  Â Â withÂ array.get_lock():
      34. Â  Â  Â  Â  Â  Â  Â  Â Â forÂ iÂ inÂ range(len(array)):
      35. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  array[i]Â =Â array[i]Â +Â worker_id
      36. Â  Â  Â  Â  Â  Â  Â  Â  logger.info(f"å·¥ä½œè¿›ç¨‹ {worker_id} æ›´æ–°æ•°ç»„: {list(array)}")
      37. Â  Â  Â  Â  Â  Â  logger.info(f"å·¥ä½œè¿›ç¨‹ {worker_id} å®Œæˆ")
      38. Â  Â  Â  Â Â # åˆ›å»ºå¹¶å¯åŠ¨è¿›ç¨‹
      39. Â  Â  Â  Â Â forÂ iÂ inÂ range(3):
      40. Â  Â  Â  Â  Â  Â  pÂ =Â mp.Process(target=worker,Â args=(shared_counter,Â shared_array,Â i))
      41. Â  Â  Â  Â  Â  Â  processes.append(p)
      42. Â  Â  Â  Â  Â  Â  p.start()
      43. Â  Â  Â  Â Â # ç­‰å¾…è¿›ç¨‹å®Œæˆ
      44. Â  Â  Â  Â Â forÂ pÂ inÂ processes:
      45. Â  Â  Â  Â  Â  Â  p.join()
      46. Â  Â  Â  Â  logger.info(f"æ‰€æœ‰è¿›ç¨‹å®Œæˆã€‚æœ€ç»ˆè®¡æ•°å™¨å€¼: {shared_counter.value}")
      47. Â  Â  Â  Â  logger.info(f"æœ€ç»ˆæ•°ç»„å€¼: {list(shared_array)}")
      48.   49. Â  Â Â defÂ using_manager(self):
      50. Â  Â  Â  Â Â """ä½¿ç”¨ Manager å…±äº«å¤æ‚æ•°æ®ç»“æ„ç¤ºä¾‹"""
      51. Â  Â  Â  Â Â # åˆ›å»ºManagerå¯¹è±¡
      52. Â  Â  Â  Â Â withÂ mp.Manager()Â asÂ manager:
      53. Â  Â  Â  Â  Â  Â Â # åˆ›å»ºå…±äº«å­—å…¸å’Œåˆ—è¡¨
      54. Â  Â  Â  Â  Â  Â  shared_dictÂ =Â manager.dict()
      55. Â  Â  Â  Â  Â  Â  shared_listÂ =Â manager.list()
      56.   57. Â  Â  Â  Â  Â  Â Â # åˆ›å»ºå…±äº«é”
      58. Â  Â  Â  Â  Â  Â  lockÂ =Â manager.RLock()
      59. Â  Â  Â  Â  Â  Â  processesÂ =Â []
      60. Â  Â  Â  Â  Â  Â Â # å®šä¹‰å·¥ä½œå‡½æ•°
      61. Â  Â  Â  Â  Â  Â Â defÂ worker(shared_dict,Â shared_list,Â lock,Â worker_id):
      62. Â  Â  Â  Â  Â  Â  Â  Â  pidÂ =Â mp.current_process().pid
      63. Â  Â  Â  Â  Â  Â  Â  Â  logger.info(f"å·¥ä½œè¿›ç¨‹ {worker_id} (PID: {pid}) å¼€å§‹")
      64.   65. Â  Â  Â  Â  Â  Â  Â  Â Â # å®‰å…¨åœ°ä¿®æ”¹å…±äº«å­—å…¸
      66. Â  Â  Â  Â  Â  Â  Â  Â Â withÂ lock:
      67. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  shared_dict[f'key_{worker_id}']Â =Â worker_idÂ *Â worker_id
      68. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  shared_dict['total']Â =Â shared_dict.get('total',Â 0)Â +Â worker_id
      69. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logger.info(f"å·¥ä½œè¿›ç¨‹ {worker_id} æ›´æ–°å­—å…¸: {dict(shared_dict)}")
      70.   71. Â  Â  Â  Â  Â  Â  Â  Â Â # å®‰å…¨åœ°ä¿®æ”¹å…±äº«åˆ—è¡¨
      72. Â  Â  Â  Â  Â  Â  Â  Â Â withÂ lock:
      73. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  shared_list.append(f"æ¥è‡ªè¿›ç¨‹ {worker_id} çš„æ•°æ®")
      74. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logger.info(f"å·¥ä½œè¿›ç¨‹ {worker_id} æ›´æ–°åˆ—è¡¨: {list(shared_list)}")
      75. Â  Â  Â  Â  Â  Â  Â  Â Â # æ¨¡æ‹Ÿä¸€äº›å·¥ä½œ
      76. Â  Â  Â  Â  Â  Â  Â  Â  time.sleep(0.5)
      77. Â  Â  Â  Â  Â  Â  Â  Â  logger.info(f"å·¥ä½œè¿›ç¨‹ {worker_id} å®Œæˆ")
      78. Â  Â  Â  Â  Â  Â Â # åˆ›å»ºå¹¶å¯åŠ¨è¿›ç¨‹
      79. Â  Â  Â  Â  Â  Â Â forÂ iÂ inÂ range(5):
      80. Â  Â  Â  Â  Â  Â  Â  Â  pÂ =Â mp.Process(
      81. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  target=worker,Â 
      82. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  args=(shared_dict,Â shared_list,Â lock,Â i),
      83. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name=f"Manager-Worker-{i}"
      84. Â  Â  Â  Â  Â  Â  Â  Â Â )
      85. Â  Â  Â  Â  Â  Â  Â  Â  processes.append(p)
      86. Â  Â  Â  Â  Â  Â  Â  Â  p.start()
      87. Â  Â  Â  Â  Â  Â Â # ç­‰å¾…è¿›ç¨‹å®Œæˆ
      88. Â  Â  Â  Â  Â  Â Â forÂ pÂ inÂ processes:
      89. Â  Â  Â  Â  Â  Â  Â  Â  p.join()
      90. Â  Â  Â  Â  Â  Â  logger.info("æ‰€æœ‰è¿›ç¨‹å®Œæˆ")
      91. Â  Â  Â  Â  Â  Â  logger.info(f"æœ€ç»ˆå…±äº«å­—å…¸: {dict(shared_dict)}")
      92. Â  Â  Â  Â  Â  Â  logger.info(f"æœ€ç»ˆå…±äº«åˆ—è¡¨: {list(shared_list)}")
      93.   94. ifÂ __name__Â ==Â "__main__":
      95. Â  Â  processorÂ =Â SharedDataProcessor()
      96. Â  Â Â print("\n=== ä½¿ç”¨ Value å’Œ Array å…±äº«æ•°æ® ===")
      97. Â  Â  processor.using_value_and_array()
      98.   99. Â  Â Â print("\n=== ä½¿ç”¨ Manager å…±äº«æ•°æ® ===")
      100. Â  Â  processor.using_manager()
    
    

### è¿›ç¨‹æ± çš„æœ€ä½³å®è·µ

å¯¹äºéœ€è¦å¹¶è¡Œå¤„ç†çš„å¤§é‡ç‹¬ç«‹ä»»åŠ¡ï¼Œè¿›ç¨‹æ± æ˜¯æ›´é«˜æ•ˆçš„é€‰æ‹©ï¼š
    
          1. importÂ multiprocessingÂ asÂ mp
      2. fromÂ concurrent.futuresÂ importÂ ProcessPoolExecutor
      3. importÂ time
      4. importÂ logging
      5. importÂ random
      6. fromÂ typingÂ importÂ List,Â Tuple,Â Any
      7. # é…ç½®æ—¥å¿—
      8. logging.basicConfig(
      9. Â  Â  level=logging.INFO,
      10. Â  Â  format='%(asctime)s - %(processName)s - %(levelname)s - %(message)s'
      11. )
      12. loggerÂ =Â logging.getLogger(__name__)
      13.   14. classÂ AdvancedTaskProcessor:
      15. Â  Â Â """é«˜çº§ä»»åŠ¡å¤„ç†å™¨ï¼Œæ¼”ç¤ºè¿›ç¨‹æ± æœ€ä½³å®è·µ"""
      16. Â  Â Â defÂ __init__(self,Â max_workers:Â intÂ =Â None):
      17. Â  Â  Â  Â Â """
      18. Â  Â  Â  Â  åˆå§‹åŒ–å¤„ç†å™¨
      19. Â  Â  Â  Â  å‚æ•°:
      20. Â  Â  Â  Â  Â  Â  max_workers: æœ€å¤§å·¥ä½œè¿›ç¨‹æ•°ï¼Œé»˜è®¤ä¸ºCPUæ ¸å¿ƒæ•°
      21. Â  Â  Â  Â  """
      22. Â  Â  Â  Â  self.max_workersÂ =Â max_workersÂ orÂ mp.cpu_count()
      23. Â  Â  Â  Â  logger.info(f"åˆå§‹åŒ–é«˜çº§ä»»åŠ¡å¤„ç†å™¨ï¼Œæœ€å¤§è¿›ç¨‹æ•°: {self.max_workers}")
      24. Â  Â Â defÂ process_single_task(self,Â task_data:Â Tuple[int,Â int])Â ->Â Tuple[int,Â float]:
      25. Â  Â  Â  Â Â """
      26. Â  Â  Â  Â  å¤„ç†å•ä¸ªä»»åŠ¡çš„å‡½æ•°
      27. Â  Â  Â  Â  å‚æ•°:
      28. Â  Â  Â  Â  Â  Â  task_data: ä»»åŠ¡æ•°æ®ï¼Œæ ¼å¼ä¸º (ä»»åŠ¡ID, ä»»åŠ¡å¤æ‚åº¦)
      29.   30. Â  Â  Â  Â  è¿”å›:
      31. Â  Â  Â  Â  Â  Â  Tuple[int, float]: (ä»»åŠ¡ID, å¤„ç†ç»“æœ)
      32. Â  Â  Â  Â  """
      33. Â  Â  Â  Â  task_id,Â complexityÂ =Â task_data
      34. Â  Â  Â  Â  process_idÂ =Â mp.current_process().pid
      35.   36. Â  Â  Â  Â  logger.info(f"è¿›ç¨‹ {process_id} å¼€å§‹å¤„ç†ä»»åŠ¡ {task_id}ï¼Œå¤æ‚åº¦: {complexity}")
      37.   38. Â  Â  Â  Â Â # æ¨¡æ‹Ÿè®¡ç®—å¯†é›†å‹å·¥ä½œ
      39. Â  Â  Â  Â  start_timeÂ =Â time.time()
      40. Â  Â  Â  Â Â # æ ¹æ®ä»»åŠ¡å¤æ‚åº¦å†³å®šè®¡ç®—é‡
      41. Â  Â  Â  Â  iterationsÂ =Â complexityÂ *Â 1000000
      42. Â  Â  Â  Â  resultÂ =Â 0
      43. Â  Â  Â  Â Â forÂ iÂ inÂ range(iterations):
      44. Â  Â  Â  Â  Â  Â  resultÂ +=Â iÂ %Â 10
      45. Â  Â  Â  Â  Â  Â Â # é¿å…è¿‡åº¦ä¼˜åŒ–
      46. Â  Â  Â  Â  Â  Â Â ifÂ iÂ %Â 1000000Â ==Â 0:
      47. Â  Â  Â  Â  Â  Â  Â  Â  resultÂ =Â resultÂ *Â 0.99999
      48.   49. Â  Â  Â  Â Â # è®¡ç®—å¤„ç†æ—¶é—´
      50. Â  Â  Â  Â  processing_timeÂ =Â time.time()Â -Â start_time
      51. Â  Â  Â  Â  logger.info(f"è¿›ç¨‹ {process_id} å®Œæˆä»»åŠ¡ {task_id}ï¼Œè€—æ—¶: {processing_time:.2f}ç§’")
      52. Â  Â  Â  Â Â returnÂ task_id,Â result
      53. Â  Â Â defÂ process_tasks_with_pool(self,Â tasks:Â List[Tuple[int,Â int]])Â ->Â List[Tuple[int,Â float]]:
      54. Â  Â  Â  Â Â """
      55. Â  Â  Â  Â  ä½¿ç”¨è¿›ç¨‹æ± å¤„ç†å¤šä¸ªä»»åŠ¡
      56. Â  Â  Â  Â  å‚æ•°:
      57. Â  Â  Â  Â  Â  Â  tasks: ä»»åŠ¡åˆ—è¡¨ï¼Œæ¯ä¸ªä»»åŠ¡ä¸º (ä»»åŠ¡ID, ä»»åŠ¡å¤æ‚åº¦) å…ƒç»„
      58.   59. Â  Â  Â  Â  è¿”å›:
      60. Â  Â  Â  Â  Â  Â  List[Tuple[int, float]]: å¤„ç†ç»“æœåˆ—è¡¨
      61. Â  Â  Â  Â  """
      62. Â  Â  Â  Â  logger.info(f"å¼€å§‹å¤„ç† {len(tasks)} ä¸ªä»»åŠ¡ï¼Œä½¿ç”¨ {self.max_workers} ä¸ªè¿›ç¨‹")
      63. Â  Â  Â  Â  start_timeÂ =Â time.time()
      64.   65. Â  Â  Â  Â  resultsÂ =Â []
      66.   67. Â  Â  Â  Â Â # ä½¿ç”¨ProcessPoolExecutorè¿›è¡Œå¹¶è¡Œå¤„ç†
      68. Â  Â  Â  Â Â withÂ ProcessPoolExecutor(max_workers=self.max_workers)Â asÂ executor:
      69. Â  Â  Â  Â  Â  Â Â # æäº¤æ‰€æœ‰ä»»åŠ¡
      70. Â  Â  Â  Â  Â  Â  futuresÂ =Â [executor.submit(self.process_single_task,Â task)Â forÂ taskÂ inÂ tasks]
      71. Â  Â  Â  Â  Â  Â Â # æ”¶é›†ç»“æœ
      72. Â  Â  Â  Â  Â  Â Â forÂ futureÂ inÂ futures:
      73. Â  Â  Â  Â  Â  Â  Â  Â Â try:
      74. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultÂ =Â future.result()
      75. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  results.append(result)
      76. Â  Â  Â  Â  Â  Â  Â  Â Â exceptÂ ExceptionÂ asÂ e:
      77. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logger.error(f"ä»»åŠ¡æ‰§è¡Œå‡ºé”™: {str(e)}")
      78. Â  Â  Â  Â  elapsedÂ =Â time.time()Â -Â start_time
      79. Â  Â  Â  Â  logger.info(f"æ‰€æœ‰ä»»åŠ¡å¤„ç†å®Œæˆï¼Œæ€»è€—æ—¶: {elapsed:.2f}ç§’")
      80.   81. Â  Â  Â  Â Â returnÂ results
      82.   83. Â  Â Â defÂ run_demo(self,Â num_tasks:Â intÂ =Â 10,Â seed:Â intÂ =Â 42):
      84. Â  Â  Â  Â Â """
      85. Â  Â  Â  Â  è¿è¡Œæ¼”ç¤º
      86.   87. Â  Â  Â  Â  å‚æ•°:
      88. Â  Â  Â  Â  Â  Â  num_tasks: ä»»åŠ¡æ•°é‡
      89. Â  Â  Â  Â  Â  Â  seed: éšæœºç§å­ï¼Œç¡®ä¿å¯é‡å¤æ€§
      90. Â  Â  Â  Â  """
      91. Â  Â  Â  Â  random.seed(seed)
      92.   93. Â  Â  Â  Â Â # åˆ›å»ºä»»åŠ¡åˆ—è¡¨ï¼Œå¤æ‚åº¦åœ¨1åˆ°5ä¹‹é—´éšæœº
      94. Â  Â  Â  Â  tasksÂ =Â [(i,Â random.randint(1,Â 5))Â forÂ iÂ inÂ range(num_tasks)]
      95. Â  Â  Â  Â  logger.info(f"åˆ›å»ºäº† {num_tasks} ä¸ªä»»åŠ¡")
      96. Â  Â  Â  Â  logger.info(f"ä»»åŠ¡åˆ—è¡¨: {tasks}")
      97.   98. Â  Â  Â  Â Â # å¤„ç†ä»»åŠ¡
      99. Â  Â  Â  Â  resultsÂ =Â self.process_tasks_with_pool(tasks)
      100. Â  Â  Â  Â Â # è¾“å‡ºç»“æœ
      101. Â  Â  Â  Â  logger.info(f"å¤„ç†ç»“æœ: {results}")
      102.   103. ifÂ __name__Â ==Â "__main__":
      104. Â  Â  processorÂ =Â AdvancedTaskProcessor()
      105. Â  Â  processor.run_demo(num_tasks=8)
    
    

## 4\. åç¨‹ç¼–ç¨‹ï¼ˆç»­ï¼‰

### åŸºäº asyncio çš„åç¨‹ç¤ºä¾‹ï¼ˆç»­ï¼‰
    
          1. importÂ asyncio
      2. importÂ logging
      3. importÂ time
      4. importÂ random
      5. fromÂ typingÂ importÂ List,Â Dict,Â Any
      6.   7. # é…ç½®æ—¥å¿—
      8. logging.basicConfig(
      9. Â  Â  level=logging.INFO,
      10. Â  Â  format='%(asctime)s - %(levelname)s - %(message)s'
      11. )
      12. loggerÂ =Â logging.getLogger(__name__)
      13. classÂ AsyncTaskManager:
      14. Â  Â Â """åŸºäºåç¨‹çš„å¼‚æ­¥ä»»åŠ¡ç®¡ç†å™¨"""
      15.   16. Â  Â Â defÂ __init__(self):
      17. Â  Â  Â  Â Â """åˆå§‹åŒ–å¼‚æ­¥ä»»åŠ¡ç®¡ç†å™¨"""
      18. Â  Â  Â  Â  logger.info("åˆå§‹åŒ–å¼‚æ­¥ä»»åŠ¡ç®¡ç†å™¨")
      19. Â  Â  Â  Â  self.resultsÂ =Â {}
      20. Â  Â  asyncÂ defÂ task_simulator(self,Â task_id:Â int,Â duration:Â float)Â ->Â Dict[str,Â Any]:
      21. Â  Â  Â  Â Â """
      22. Â  Â  Â  Â  æ¨¡æ‹Ÿä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡
      23. Â  Â  Â  Â  å‚æ•°:
      24. Â  Â  Â  Â  Â  Â  task_id: ä»»åŠ¡ID
      25. Â  Â  Â  Â  Â  Â  duration: æ¨¡æ‹Ÿçš„ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
      26. Â  Â  Â  Â  è¿”å›:
      27. Â  Â  Â  Â  Â  Â  Dict: ä»»åŠ¡ç»“æœæ•°æ®
      28. Â  Â  Â  Â  """
      29. Â  Â  Â  Â  logger.info(f"ä»»åŠ¡ {task_id} å¼€å§‹ï¼Œé¢„è®¡è€—æ—¶ {duration:.2f}ç§’")
      30.   31. Â  Â  Â  Â Â # æ¨¡æ‹Ÿä¸åŒä»»åŠ¡é˜¶æ®µ
      32. Â  Â  Â  Â  stagesÂ =Â ['åˆå§‹åŒ–',Â 'æ•°æ®åŠ è½½',Â 'å¤„ç†ä¸­',Â 'å®Œæˆ']
      33. Â  Â  Â  Â  result_dataÂ =Â {
      34. Â  Â  Â  Â  Â  Â Â 'task_id':Â task_id,
      35. Â  Â  Â  Â  Â  Â Â 'stages':Â {},
      36. Â  Â  Â  Â  Â  Â Â 'total_time':Â 0
      37. Â  Â  Â  Â Â }
      38. Â  Â  Â  Â  start_timeÂ =Â time.time()
      39. Â  Â  Â  Â Â # åˆ†é˜¶æ®µæ‰§è¡Œä»»åŠ¡
      40. Â  Â  Â  Â  stage_timeÂ =Â durationÂ /Â len(stages)
      41. Â  Â  Â  Â Â forÂ i,Â stageÂ inÂ enumerate(stages):
      42. Â  Â  Â  Â  Â  Â Â # æ¨¡æ‹Ÿæ¯ä¸ªé˜¶æ®µçš„å·¥ä½œ
      43. Â  Â  Â  Â  Â  Â  stage_startÂ =Â time.time()
      44. Â  Â  Â  Â  Â  Â Â # ä½¿ç”¨asyncio.sleepæ¨¡æ‹Ÿå¼‚æ­¥IOæ“ä½œ
      45. Â  Â  Â  Â  Â  Â  variationÂ =Â random.uniform(0.8,Â 1.2)Â Â # å¢åŠ ä¸€äº›éšæœºæ€§
      46. Â  Â  Â  Â  Â  Â  await asyncio.sleep(stage_timeÂ *Â variation)
      47. Â  Â  Â  Â  Â  Â  stage_durationÂ =Â time.time()Â -Â stage_start
      48. Â  Â  Â  Â  Â  Â  result_data['stages'][stage]Â =Â stage_duration
      49.   50. Â  Â  Â  Â  Â  Â  logger.debug(f"ä»»åŠ¡ {task_id}: {stage} é˜¶æ®µå®Œæˆï¼Œè€—æ—¶ {stage_duration:.2f}ç§’")
      51.   52. Â  Â  Â  Â Â # è®¡ç®—æ€»è€—æ—¶
      53. Â  Â  Â  Â  total_timeÂ =Â time.time()Â -Â start_time
      54. Â  Â  Â  Â  result_data['total_time']Â =Â total_time
      55.   56. Â  Â  Â  Â  logger.info(f"ä»»åŠ¡ {task_id} å®Œæˆï¼Œæ€»è€—æ—¶ {total_time:.2f}ç§’")
      57. Â  Â  Â  Â Â returnÂ result_data
      58. Â  Â  asyncÂ defÂ run_tasks(self,Â num_tasks:Â intÂ =Â 5,Â min_duration:Â floatÂ =Â 1.0,Â 
      59. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  max_duration:Â floatÂ =Â 5.0)Â ->Â List[Dict[str,Â Any]]:
      60. Â  Â  Â  Â Â """
      61. Â  Â  Â  Â  å¹¶å‘è¿è¡Œå¤šä¸ªå¼‚æ­¥ä»»åŠ¡
      62.   63. Â  Â  Â  Â  å‚æ•°:
      64. Â  Â  Â  Â  Â  Â  num_tasks: ä»»åŠ¡æ•°é‡
      65. Â  Â  Â  Â  Â  Â  min_duration: æœ€å°ä»»åŠ¡æŒç»­æ—¶é—´
      66. Â  Â  Â  Â  Â  Â  max_duration: æœ€å¤§ä»»åŠ¡æŒç»­æ—¶é—´
      67. Â  Â  Â  Â  è¿”å›:
      68. Â  Â  Â  Â  Â  Â  List[Dict]: æ‰€æœ‰ä»»åŠ¡ç»“æœåˆ—è¡¨
      69. Â  Â  Â  Â  """
      70. Â  Â  Â  Â  logger.info(f"å‡†å¤‡è¿è¡Œ {num_tasks} ä¸ªå¼‚æ­¥ä»»åŠ¡")
      71.   72. Â  Â  Â  Â Â # ç”Ÿæˆéšæœºä»»åŠ¡æŒç»­æ—¶é—´
      73. Â  Â  Â  Â  durationsÂ =Â [random.uniform(min_duration,Â max_duration)Â forÂ _Â inÂ range(num_tasks)]
      74. Â  Â  Â  Â Â # åˆ›å»ºä»»åŠ¡åˆ—è¡¨
      75. Â  Â  Â  Â  tasksÂ =Â [
      76. Â  Â  Â  Â  Â  Â  self.task_simulator(i,Â durations[i])Â forÂ iÂ inÂ range(num_tasks)
      77. Â  Â  Â  Â Â ]
      78.   79. Â  Â  Â  Â Â # å¹¶å‘æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡
      80. Â  Â  Â  Â  start_timeÂ =Â time.time()
      81. Â  Â  Â  Â  resultsÂ =Â await asyncio.gather(*tasks)
      82. Â  Â  Â  Â  total_timeÂ =Â time.time()Â -Â start_time
      83. Â  Â  Â  Â Â # åˆ†æç»“æœ
      84. Â  Â  Â  Â  theoretical_sequential_timeÂ =Â sum(durations)
      85. Â  Â  Â  Â  speedupÂ =Â theoretical_sequential_timeÂ /Â total_time
      86. Â  Â  Â  Â  logger.info(f"æ‰€æœ‰ä»»åŠ¡å®Œæˆ! æ€»è€—æ—¶: {total_time:.2f}ç§’")
      87. Â  Â  Â  Â  logger.info(f"å¦‚æœé¡ºåºæ‰§è¡Œé¢„è®¡éœ€è¦: {theoretical_sequential_time:.2f}ç§’")
      88. Â  Â  Â  Â  logger.info(f"åŠ é€Ÿæ¯”: {speedup:.2f}x")
      89. Â  Â  Â  Â Â returnÂ results
      90.   91. asyncÂ defÂ main():
      92. Â  Â Â """ä¸»å‡½æ•°"""
      93. Â  Â  managerÂ =Â AsyncTaskManager()
      94.   95. Â  Â Â # è¿è¡Œå¹¶å‘ä»»åŠ¡
      96. Â  Â  resultsÂ =Â await manager.run_tasks(num_tasks=10,Â min_duration=1.0,Â max_duration=3.0)
      97. Â  Â Â # è¾“å‡ºç»“æœæ‘˜è¦
      98. Â  Â Â print("\nä»»åŠ¡æ‰§è¡Œæ‘˜è¦:")
      99. Â  Â Â forÂ resultÂ inÂ results:
      100. Â  Â  Â  Â  task_idÂ =Â result['task_id']
      101. Â  Â  Â  Â  total_timeÂ =Â result['total_time']
      102. Â  Â  Â  Â Â print(f"ä»»åŠ¡ {task_id}: æ€»è€—æ—¶ {total_time:.2f}ç§’")
      103.   104. ifÂ __name__Â ==Â "__main__":
      105. Â  Â Â # åœ¨Python 3.7+ä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨asyncio.run()
      106. Â  Â  asyncio.run(main())
    
    

### ä½¿ç”¨ aiohttp è¿›è¡Œé«˜æ•ˆç½‘ç»œè¯·æ±‚

åç¨‹åœ¨ç½‘ç»œ IO åœºæ™¯ä¸­ç‰¹åˆ«é«˜æ•ˆã€‚ä¸‹é¢æ˜¯ä½¿ç”¨ aiohttp å®ç°å¹¶å‘ä¸‹è½½å¤šä¸ªæ–‡ä»¶çš„ç¤ºä¾‹ï¼š
    
          1. importÂ asyncio
      2. importÂ aiohttp
      3. importÂ logging
      4. importÂ time
      5. importÂ os
      6. fromÂ typingÂ importÂ List,Â Tuple,Â Dict,Â Any
      7. fromÂ aiohttpÂ importÂ ClientSession
      8. importÂ aiofiles Â # éœ€è¦å…ˆå®‰è£…: pip install aiofiles
      9. # é…ç½®æ—¥å¿—
      10. logging.basicConfig(
      11. Â  Â  level=logging.INFO,
      12. Â  Â  format='%(asctime)s - %(levelname)s - %(message)s'
      13. )
      14. loggerÂ =Â logging.getLogger(__name__)
      15.   16. classÂ AsyncDownloader:
      17. Â  Â Â """å¼‚æ­¥HTTPä¸‹è½½å™¨ï¼ŒåŸºäºaiohttpå’Œasyncioå®ç°"""
      18. Â  Â Â defÂ __init__(self,Â download_dir:Â strÂ =Â "./downloads",Â chunk_size:Â intÂ =Â 8192):
      19. Â  Â  Â  Â Â """
      20. Â  Â  Â  Â  åˆå§‹åŒ–ä¸‹è½½å™¨
      21. Â  Â  Â  Â  å‚æ•°:
      22. Â  Â  Â  Â  Â  Â  download_dir: ä¸‹è½½æ–‡ä»¶ä¿å­˜ç›®å½•
      23. Â  Â  Â  Â  Â  Â  chunk_size: ä¸‹è½½æ—¶çš„å—å¤§å°ï¼ˆå­—èŠ‚ï¼‰
      24. Â  Â  Â  Â  """
      25. Â  Â  Â  Â  self.download_dirÂ =Â download_dir
      26. Â  Â  Â  Â  self.chunk_sizeÂ =Â chunk_size
      27.   28. Â  Â  Â  Â Â # ç¡®ä¿ä¸‹è½½ç›®å½•å­˜åœ¨
      29. Â  Â  Â  Â  os.makedirs(download_dir,Â exist_ok=True)
      30. Â  Â  Â  Â  logger.info(f"å¼‚æ­¥ä¸‹è½½å™¨åˆå§‹åŒ–å®Œæˆï¼Œä¸‹è½½ç›®å½•: {download_dir}")
      31. Â  Â  asyncÂ defÂ download_file(self,Â session:Â ClientSession,Â url:Â str,Â 
      32. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â file_name:Â str)Â ->Â Dict[str,Â Any]:
      33. Â  Â  Â  Â Â """
      34. Â  Â  Â  Â  å¼‚æ­¥ä¸‹è½½å•ä¸ªæ–‡ä»¶
      35.   36. Â  Â  Â  Â  å‚æ•°:
      37. Â  Â  Â  Â  Â  Â  session: aiohttpä¼šè¯å¯¹è±¡
      38. Â  Â  Â  Â  Â  Â  url: ä¸‹è½½URL
      39. Â  Â  Â  Â  Â  Â  file_name: ä¿å­˜çš„æ–‡ä»¶å
      40. Â  Â  Â  Â  è¿”å›:
      41. Â  Â  Â  Â  Â  Â  Dict: ä¸‹è½½ç»“æœä¿¡æ¯
      42. Â  Â  Â  Â  """
      43. Â  Â  Â  Â  file_pathÂ =Â os.path.join(self.download_dir,Â file_name)
      44. Â  Â  Â  Â  start_timeÂ =Â time.time()
      45. Â  Â  Â  Â Â # è®°å½•ä¸‹è½½ä¿¡æ¯
      46. Â  Â  Â  Â  resultÂ =Â {
      47. Â  Â  Â  Â  Â  Â Â 'url':Â url,
      48. Â  Â  Â  Â  Â  Â Â 'file_name':Â file_name,
      49. Â  Â  Â  Â  Â  Â Â 'file_path':Â file_path,
      50. Â  Â  Â  Â  Â  Â Â 'success':Â False,
      51. Â  Â  Â  Â  Â  Â Â 'file_size':Â 0,
      52. Â  Â  Â  Â  Â  Â Â 'download_time':Â 0,
      53. Â  Â  Â  Â  Â  Â Â 'speed':Â 0,
      54. Â  Â  Â  Â  Â  Â Â 'error':Â None
      55. Â  Â  Â  Â Â }
      56. Â  Â  Â  Â Â try:
      57. Â  Â  Â  Â  Â  Â  logger.info(f"å¼€å§‹ä¸‹è½½: {file_name} ä» {url}")
      58.   59. Â  Â  Â  Â  Â  Â Â # å‘é€è¯·æ±‚å¹¶æµå¼ä¸‹è½½
      60. Â  Â  Â  Â  Â  Â  asyncÂ withÂ session.get(url,Â ssl=False)Â asÂ response:
      61. Â  Â  Â  Â  Â  Â  Â  Â Â ifÂ response.statusÂ !=Â 200:
      62. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  error_msgÂ =Â f"HTTPé”™è¯¯: {response.status} - {response.reason}"
      63. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logger.error(error_msg)
      64. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result['error']Â =Â error_msg
      65. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â returnÂ result
      66.   67. Â  Â  Â  Â  Â  Â  Â  Â Â # è·å–æ–‡ä»¶å¤§å°ï¼ˆå¦‚æœæœåŠ¡å™¨æä¾›ï¼‰
      68. Â  Â  Â  Â  Â  Â  Â  Â  content_lengthÂ =Â response.headers.get('Content-Length')
      69. Â  Â  Â  Â  Â  Â  Â  Â Â ifÂ content_length:
      70. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_sizeÂ =Â int(content_length)
      71. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result['file_size']Â =Â total_size
      72. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logger.info(f"{file_name} å¤§å°: {total_size/1024:.1f} KB")
      73. Â  Â  Â  Â  Â  Â  Â  Â Â # å¼‚æ­¥å†™å…¥æ–‡ä»¶
      74. Â  Â  Â  Â  Â  Â  Â  Â  asyncÂ withÂ aiofiles.open(file_path,Â 'wb')Â asÂ f:
      75. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadedÂ =Â 0
      76. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  last_log_timeÂ =Â time.time()
      77.   78. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â # æµå¼ä¸‹è½½ï¼Œé¿å…å†…å­˜æº¢å‡º
      79. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  asyncÂ forÂ chunkÂ inÂ response.content.iter_chunked(self.chunk_size):
      80. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await f.write(chunk)
      81. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadedÂ +=Â len(chunk)
      82. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â # æ¯ç§’æœ€å¤šè®°å½•ä¸€æ¬¡è¿›åº¦
      83. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  current_timeÂ =Â time.time()
      84. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â ifÂ current_timeÂ -Â last_log_timeÂ >=Â 1.0Â andÂ total_sizeÂ >Â 0:
      85. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progressÂ =Â (downloadedÂ /Â total_size)Â *Â 100
      86. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logger.debug(f"{file_name} - ä¸‹è½½è¿›åº¦: {progress:.1f}%")
      87. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  last_log_timeÂ =Â current_time
      88.   89. Â  Â  Â  Â  Â  Â Â # è®¡ç®—ä¸‹è½½ç»Ÿè®¡ä¿¡æ¯
      90. Â  Â  Â  Â  Â  Â  download_timeÂ =Â time.time()Â -Â start_time
      91. Â  Â  Â  Â  Â  Â  speedÂ =Â result['file_size']Â /Â download_timeÂ ifÂ download_timeÂ >Â 0Â elseÂ 0
      92.   93. Â  Â  Â  Â  Â  Â  result.update({
      94. Â  Â  Â  Â  Â  Â  Â  Â Â 'success':Â True,
      95. Â  Â  Â  Â  Â  Â  Â  Â Â 'download_time':Â download_time,
      96. Â  Â  Â  Â  Â  Â  Â  Â Â 'speed':Â speed
      97. Â  Â  Â  Â  Â  Â Â })
      98.   99. Â  Â  Â  Â  Â  Â  logger.info(f"{file_name} ä¸‹è½½å®Œæˆ - "
      100. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  f"è€—æ—¶: {download_time:.2f}ç§’, "
      101. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  f"é€Ÿåº¦: {speed/1024:.1f} KB/s")
      102.   103. Â  Â  Â  Â  Â  Â Â returnÂ result
      104.   105. Â  Â  Â  Â Â exceptÂ aiohttp.ClientErrorÂ asÂ e:
      106. Â  Â  Â  Â  Â  Â  error_msgÂ =Â f"ç½‘ç»œé”™è¯¯: {str(e)}"
      107. Â  Â  Â  Â  Â  Â  logger.error(f"ä¸‹è½½ {file_name} å¤±è´¥: {error_msg}")
      108. Â  Â  Â  Â  Â  Â  result['error']Â =Â error_msg
      109. Â  Â  Â  Â  Â  Â Â returnÂ result
      110.   111. Â  Â  Â  Â Â exceptÂ asyncio.CancelledError:
      112. Â  Â  Â  Â  Â  Â  error_msgÂ =Â "ä¸‹è½½è¢«å–æ¶ˆ"
      113. Â  Â  Â  Â  Â  Â  logger.warning(f"{file_name} ä¸‹è½½è¢«å–æ¶ˆ")
      114. Â  Â  Â  Â  Â  Â  result['error']Â =Â error_msg
      115. Â  Â  Â  Â  Â  Â Â returnÂ result
      116.   117. Â  Â  Â  Â Â exceptÂ ExceptionÂ asÂ e:
      118. Â  Â  Â  Â  Â  Â  error_msgÂ =Â f"æœªçŸ¥é”™è¯¯: {str(e)}"
      119. Â  Â  Â  Â  Â  Â  logger.error(f"ä¸‹è½½ {file_name} æ—¶å‘ç”Ÿå¼‚å¸¸: {error_msg}")
      120. Â  Â  Â  Â  Â  Â  result['error']Â =Â error_msg
      121. Â  Â  Â  Â  Â  Â Â returnÂ result
      122.   123. Â  Â  asyncÂ defÂ download_batch(self,Â urls:Â List[Tuple[str,Â str]],Â 
      124. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â max_concurrent:Â intÂ =Â 5)Â ->Â List[Dict[str,Â Any]]:
      125. Â  Â  Â  Â Â """
      126. Â  Â  Â  Â  æ‰¹é‡å¹¶å‘ä¸‹è½½å¤šä¸ªæ–‡ä»¶
      127. Â  Â  Â  Â  å‚æ•°:
      128. Â  Â  Â  Â  Â  Â  urls: åŒ…å«(æ–‡ä»¶å, URL)å…ƒç»„çš„åˆ—è¡¨
      129. Â  Â  Â  Â  Â  Â  max_concurrent: æœ€å¤§å¹¶å‘ä¸‹è½½æ•°
      130. Â  Â  Â  Â  è¿”å›:
      131. Â  Â  Â  Â  Â  Â  List[Dict]: ä¸‹è½½ç»“æœåˆ—è¡¨
      132. Â  Â  Â  Â  """
      133. Â  Â  Â  Â Â ifÂ notÂ urls:
      134. Â  Â  Â  Â  Â  Â  logger.warning("æ²¡æœ‰æä¾›ä¸‹è½½URL")
      135. Â  Â  Â  Â  Â  Â Â returnÂ []
      136.   137. Â  Â  Â  Â  logger.info(f"å¼€å§‹æ‰¹é‡ä¸‹è½½ {len(urls)} ä¸ªæ–‡ä»¶ï¼Œæœ€å¤§å¹¶å‘æ•°: {max_concurrent}")
      138. Â  Â  Â  Â  start_timeÂ =Â time.time()
      139. Â  Â  Â  Â Â # åˆ›å»ºé™åˆ¶å¹¶å‘æ•°çš„ä¿¡å·é‡
      140. Â  Â  Â  Â  semaphoreÂ =Â asyncio.Semaphore(max_concurrent)
      141.   142. Â  Â  Â  Â Â # å®šä¹‰å¸¦ä¿¡å·é‡çš„ä¸‹è½½å‡½æ•°
      143. Â  Â  Â  Â  asyncÂ defÂ bounded_download(session,Â file_name,Â url):
      144. Â  Â  Â  Â  Â  Â  asyncÂ withÂ semaphore:
      145. Â  Â  Â  Â  Â  Â  Â  Â Â returnÂ await self.download_file(session,Â url,Â file_name)
      146. Â  Â  Â  Â Â # åˆ›å»ºä¼šè¯å¹¶å‘é€è¯·æ±‚
      147. Â  Â  Â  Â  asyncÂ withÂ aiohttp.ClientSession()Â asÂ session:
      148. Â  Â  Â  Â  Â  Â Â # åˆ›å»ºæ‰€æœ‰ä¸‹è½½ä»»åŠ¡
      149. Â  Â  Â  Â  Â  Â  tasksÂ =Â [
      150. Â  Â  Â  Â  Â  Â  Â  Â  bounded_download(session,Â file_name,Â url)
      151. Â  Â  Â  Â  Â  Â  Â  Â Â forÂ file_name,Â urlÂ inÂ urls
      152. Â  Â  Â  Â  Â  Â Â ]
      153. Â  Â  Â  Â  Â  Â Â # å¹¶å‘æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡
      154. Â  Â  Â  Â  Â  Â  resultsÂ =Â await asyncio.gather(*tasks,Â return_exceptions=True)
      155.   156. Â  Â  Â  Â Â # å¤„ç†ç»“æœ
      157. Â  Â  Â  Â  processed_resultsÂ =Â []
      158. Â  Â  Â  Â  success_countÂ =Â 0
      159.   160. Â  Â  Â  Â Â forÂ resultÂ inÂ results:
      161. Â  Â  Â  Â  Â  Â Â # æ£€æŸ¥æ˜¯å¦å‘ç”Ÿå¼‚å¸¸
      162. Â  Â  Â  Â  Â  Â Â ifÂ isinstance(result,Â Exception):
      163. Â  Â  Â  Â  Â  Â  Â  Â  logger.error(f"ä¸‹è½½ä»»åŠ¡å¼‚å¸¸: {str(result)}")
      164. Â  Â  Â  Â  Â  Â  Â  Â  processed_results.append({
      165. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 'success':Â False,
      166. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 'error':Â str(result)
      167. Â  Â  Â  Â  Â  Â  Â  Â Â })
      168. Â  Â  Â  Â  Â  Â Â else:
      169. Â  Â  Â  Â  Â  Â  Â  Â  processed_results.append(result)
      170. Â  Â  Â  Â  Â  Â  Â  Â Â ifÂ result['success']:
      171. Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  success_countÂ +=Â 1
      172. Â  Â  Â  Â Â # ç»Ÿè®¡ä¿¡æ¯
      173. Â  Â  Â  Â  total_timeÂ =Â time.time()Â -Â start_time
      174. Â  Â  Â  Â  success_rateÂ =Â (success_countÂ /Â len(urls))Â *Â 100Â ifÂ urlsÂ elseÂ 0
      175. Â  Â  Â  Â  logger.info(f"æ‰¹é‡ä¸‹è½½å®Œæˆ! æ€»è€—æ—¶: {total_time:.2f}ç§’")
      176. Â  Â  Â  Â  logger.info(f"æˆåŠŸ: {success_count}/{len(urls)} ({success_rate:.1f}%)")
      177.   178. Â  Â  Â  Â Â returnÂ processed_results
      179.   180. asyncÂ defÂ main():
      181. Â  Â Â """ä¸»å‡½æ•°"""
      182. Â  Â Â # åˆ›å»ºä¸‹è½½å™¨å®ä¾‹
      183. Â  Â  downloaderÂ =Â AsyncDownloader(download_dir="./downloads")
      184.   185. Â  Â Â # å‡†å¤‡ä¸‹è½½åˆ—è¡¨ï¼ˆæ›¿æ¢ä¸ºå®é™…å¯ç”¨çš„URLï¼‰
      186. Â  Â  urlsÂ =Â [
      187. Â  Â  Â  Â Â ("image1.jpg",Â "https://example.com/image1.jpg"),
      188. Â  Â  Â  Â Â ("image2.jpg",Â "https://example.com/image2.jpg"),
      189. Â  Â  Â  Â Â ("image3.jpg",Â "https://example.com/image3.jpg"),
      190. Â  Â  Â  Â Â ("document1.pdf",Â "https://example.com/document1.pdf"),
      191. Â  Â  Â  Â Â ("document2.pdf",Â "https://example.com/document2.pdf")
      192. Â  Â Â ]
      193. Â  Â Â # å¼€å§‹æ‰¹é‡ä¸‹è½½
      194. Â  Â  resultsÂ =Â await downloader.download_batch(urls,Â max_concurrent=3)
      195.   196. Â  Â Â # æ‰“å°ä¸‹è½½ç»“æœæ‘˜è¦
      197. Â  Â Â print("\nä¸‹è½½ç»“æœæ‘˜è¦:")
      198. Â  Â Â forÂ resultÂ inÂ results:
      199. Â  Â  Â  Â Â ifÂ result.get('success'):
      200. Â  Â  Â  Â  Â  Â  file_nameÂ =Â result.get('file_name')
      201. Â  Â  Â  Â  Â  Â  size_kbÂ =Â result.get('file_size',Â 0)Â /Â 1024
      202. Â  Â  Â  Â  Â  Â  time_sÂ =Â result.get('download_time',Â 0)
      203. Â  Â  Â  Â  Â  Â  speed_kbpsÂ =Â result.get('speed',Â 0)Â /Â 1024
      204. Â  Â  Â  Â  Â  Â Â print(f"âœ… {file_name}: {size_kb:.1f} KB, {time_s:.2f}ç§’, {speed_kbps:.1f} KB/s")
      205. Â  Â  Â  Â Â else:
      206. Â  Â  Â  Â  Â  Â  urlÂ =Â result.get('url',Â 'Unknown URL')
      207. Â  Â  Â  Â  Â  Â  errorÂ =Â result.get('error',Â 'Unknown error')
      208. Â  Â  Â  Â  Â  Â Â print(f"âŒ {url}: {error}")
      209.   210. ifÂ __name__Â ==Â "__main__":
      211. Â  Â Â # åœ¨Python 3.7+ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨asyncio.run()
      212. Â  Â  asyncio.run(main())
    
    

## 5\. å¹¶å‘æ¨¡å¼é€‰æ‹©æŒ‡å—

æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©åˆé€‚çš„å¹¶å‘æ¨¡å¼éå¸¸é‡è¦ï¼Œä¸‹é¢æ˜¯é€‰æ‹©æŒ‡å—ï¼š

### 5.1 å¤šçº¿ç¨‹é€‚ç”¨åœºæ™¯

  *  **IO å¯†é›†å‹ä»»åŠ¡** ï¼šæ–‡ä»¶è¯»å†™ã€ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æ“ä½œ
  *  **éœ€è¦å…±äº«å†…å­˜** ï¼šçº¿ç¨‹é—´å¯ç›´æ¥å…±äº«å˜é‡å’Œå¯¹è±¡
  *  **ä¸å¤–éƒ¨åº“é›†æˆ** ï¼šè®¸å¤šç¬¬ä¸‰æ–¹åº“ä¸æ”¯æŒå¼‚æ­¥ï¼Œä½†æ”¯æŒå¤šçº¿ç¨‹



### 5.2 å¤šè¿›ç¨‹é€‚ç”¨åœºæ™¯

  *  **CPU å¯†é›†å‹ä»»åŠ¡** ï¼šæ•°å­¦è®¡ç®—ã€å›¾åƒå¤„ç†ã€æ•°æ®åˆ†æ
  *  **éœ€è¦éš”ç¦»å®‰å…¨** ï¼šå„è¿›ç¨‹ç‹¬ç«‹è¿è¡Œï¼Œä¸€ä¸ªè¿›ç¨‹å´©æºƒä¸å½±å“å…¶ä»–è¿›ç¨‹
  *  **å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU** ï¼šç»•è¿‡ GIL é™åˆ¶ï¼Œå®ç°çœŸæ­£çš„å¹¶è¡Œè®¡ç®—



### 5.3 åç¨‹é€‚ç”¨åœºæ™¯

  *  **é«˜å¹¶å‘ IO æ“ä½œ** ï¼šç½‘ç»œçˆ¬è™«ã€API è°ƒç”¨ã€å¾®æœåŠ¡é€šä¿¡
  *  **èµ„æºæ¶ˆè€—æ•æ„Ÿ** ï¼šåç¨‹å¼€é”€è¿œå°äºçº¿ç¨‹å’Œè¿›ç¨‹
  *  **éœ€è¦ç²¾ç»†æ§åˆ¶ä»»åŠ¡è°ƒåº¦** ï¼šåç¨‹å¯ä»¥ç²¾ç¡®æ§åˆ¶ä»»åŠ¡åˆ‡æ¢æ—¶æœº



## 6\. æ€»ç»“ä¸æœ€ä½³å®è·µ

### 6.1 ä¸»è¦æ¦‚å¿µå¯¹æ¯”

ç‰¹æ€§| å¤šçº¿ç¨‹| å¤šè¿›ç¨‹| åç¨‹  
---|---|---|---  
é€‚ç”¨ä»»åŠ¡ç±»å‹| IO å¯†é›†å‹| CPU å¯†é›†å‹| IO å¯†é›†å‹  
èµ„æºæ¶ˆè€—| ä¸­ç­‰| é«˜| ä½  
æ•°æ®å…±äº«| ç›´æ¥å…±äº«| éœ€ç‰¹æ®Šæœºåˆ¶| ç›´æ¥å…±äº«  
å¹¶è¡Œæ‰§è¡Œ| å— GIL é™åˆ¶| çœŸæ­£å¹¶è¡Œ| å•çº¿ç¨‹å†…å¹¶å‘  
å¼€å‘å¤æ‚åº¦| ä¸­ç­‰| ä¸­ç­‰| è¾ƒé«˜ï¼ˆéœ€ç†è§£å¼‚æ­¥ï¼‰  
åˆ‡æ¢å¼€é”€| ä¸­ç­‰| é«˜| æä½  
  
### 6.2 å¹¶å‘ç¼–ç¨‹æœ€ä½³å®è·µ

  1.  **æ˜ç¡®é—®é¢˜ç±»å‹** ï¼šé¦–å…ˆç¡®å®šä»»åŠ¡æ˜¯ CPU å¯†é›†å‹è¿˜æ˜¯ IO å¯†é›†å‹ï¼Œå†é€‰æ‹©å¹¶å‘æ–¹æ¡ˆã€‚
  2.  **é¿å…å…±äº«çŠ¶æ€** ï¼šå°½é‡å‡å°‘çº¿ç¨‹/è¿›ç¨‹é—´çš„æ•°æ®å…±äº«ï¼Œå¿…è¦æ—¶ä½¿ç”¨é”æˆ–æ¶ˆæ¯ä¼ é€’ã€‚
  3.  **åˆç†ä½¿ç”¨æ± åŒ–** ï¼šä½¿ç”¨çº¿ç¨‹æ± ã€è¿›ç¨‹æ± ç®¡ç†èµ„æºï¼Œé¿å…é¢‘ç¹åˆ›å»ºé”€æ¯çš„å¼€é”€ã€‚
  4.  **å–„ç”¨å¼‚æ­¥åº“** ï¼šä½¿ç”¨åç¨‹æ—¶ï¼Œä¼˜å…ˆé€‰æ‹©æ”¯æŒå¼‚æ­¥ IO çš„åº“ï¼ˆå¦‚ aiohttpã€asyncpgï¼‰ã€‚
  5.  **å¼‚å¸¸å¤„ç†** ï¼šç¡®ä¿æ•è·å¹¶å¦¥å–„å¤„ç†æ‰€æœ‰å­ä»»åŠ¡ä¸­çš„å¼‚å¸¸ï¼Œé˜²æ­¢é™é»˜å¤±è´¥ã€‚
  6.  **è¶…æ—¶æ§åˆ¶** ï¼šè®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…ä»»åŠ¡æ— é™ç­‰å¾…ã€‚
  7.  **ç›‘æ§ä¸æ—¥å¿—** ï¼šå®ç°è‰¯å¥½çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºè°ƒè¯•å’Œæ€§èƒ½åˆ†æã€‚
  8.  **èµ„æºç®¡ç†** ï¼šæ­£ç¡®é‡Šæ”¾èµ„æºï¼Œä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆ `with` è¯­å¥ï¼‰è‡ªåŠ¨æ¸…ç†ã€‚

  

