<!DOCTYPE html>
<!-- HTML5æ–‡æ¡£ç±»å‹å£°æ˜ï¼Œç¡®ä¿æµè§ˆå™¨ä½¿ç”¨æœ€æ–°æ ‡å‡†æ¨¡å¼æ¸²æŸ“é¡µé¢ -->
<html lang="zh-CN">
<!-- HTMLæ ¹å…ƒç´ ï¼Œè®¾ç½®è¯­è¨€ä¸ºä¸­å›½å¤§é™†ç®€ä½“ä¸­æ–‡ -->
<head>
    <!-- è®¾ç½®æ–‡æ¡£å­—ç¬¦ç¼–ç ä¸ºUTF-8ï¼Œæ”¯æŒä¸­æ–‡åŠå…¶ä»–å¤šå­—èŠ‚å­—ç¬¦ -->
    <meta charset="UTF-8">
    <!-- è®¾ç½®è§†å£å…ƒæ•°æ®ï¼Œç¡®ä¿é¡µé¢åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæ­£ç¡®ç¼©æ”¾å’Œæ˜¾ç¤º -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- é¡µé¢æ ‡é¢˜ï¼ŒåŠ¨æ€æ˜¾ç¤ºå©šç¤¼äº‹ä»¶æ ‡é¢˜ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºé»˜è®¤çš„â€œå©šç¤¼é‚€è¯·â€ -->
    <title>åœ°å›¾ä½ç½® - {{ wedding_event.title|default:"å©šç¤¼é‚€è¯·" }}</title>
    <!-- å¼•å…¥é¡¹ç›®è‡ªå®šä¹‰CSSæ ·å¼è¡¨ï¼ŒåŒ…å«é€šç”¨æ ·å¼å®šä¹‰ -->
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- å¼•å…¥Google Fontsçš„æ€æºå®‹ä½“å­—ä½“ï¼Œæä¾›ä¼˜é›…çš„ä¸­æ–‡å­—ä½“æ˜¾ç¤º -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif SC', serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #5a3d5c;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,245,240,0.9) 100%);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            color: #d4af37;
            margin-bottom: 10px;
        }

        .location-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin: 30px 0;
        }

        #amap-container {
            width: 100%;
            position: relative;
            height: 400px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .map-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(248, 249, 250, 0.9);
            z-index: 1000;
            border-radius: 10px;
        }

        .back-home {
            display: inline-block;
            padding: 10px 20px;
            background: #d4af37;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .back-home:hover {
            background: #c19b2e;
        }
        
        /* ç½®ä¿¡åº¦æŒ‡ç¤ºå™¨æ ·å¼ */
        .confidence-info {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .high-confidence {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .medium-confidence {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .low-confidence {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .unknown-confidence {
            background-color: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }
        
        /* é¹°çœ¼å›¾æ§ä»¶å°ºå¯¸è°ƒæ•´ */
        .amap-overview {
            width: 150px !important;
            height: 112px !important;
        }
    </style>
</head>
<body>
    <!-- é¡µé¢ä¸»å®¹å™¨ï¼Œé™åˆ¶å†…å®¹æœ€å¤§å®½åº¦å¹¶å±…ä¸­æ˜¾ç¤º -->
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨åŒºåŸŸï¼Œç”¨äºæ˜¾ç¤ºæ ‡é¢˜ -->
        <div class="header">
            <!-- å©šç¤¼åœ°ç‚¹æ ‡é¢˜ -->
            <h1>å©šç¤¼åœ°ç‚¹</h1>
        </div>

        <!-- æ£€æŸ¥æ˜¯å¦å­˜åœ¨å©šç¤¼äº‹ä»¶ä¿¡æ¯ -->
        {% if wedding_event %}
        <!-- ä½ç½®ä¿¡æ¯å¡ç‰‡ï¼ŒåŒ…å«åœ°å›¾å’Œè¯¦ç»†ä¿¡æ¯ -->
        <div class="location-card">
            <!-- åœ°å›¾å±•ç¤ºåŒºåŸŸ -->
            <div class="map-section">
                <!-- é«˜å¾·åœ°å›¾å®¹å™¨ï¼Œç”¨äºåµŒå…¥åœ°å›¾ç»„ä»¶ -->
                <div id="amap-container">
                    <!-- åœ°å›¾åŠ è½½æç¤ºï¼Œå½“åœ°å›¾æ­£åœ¨åŠ è½½æ—¶æ˜¾ç¤º -->
                    <div class="map-loading" id="map-loading">
                        <p>æ­£åœ¨åŠ è½½åœ°å›¾...</p>
                    </div>
                </div>
            </div>

            <!-- ä½ç½®è¯¦ç»†ä¿¡æ¯å±•ç¤ºåŒºåŸŸ -->
            <div class="location-info">
                <!-- ä¸¾åŠåœ°ç‚¹ä¿¡æ¯é¡¹ -->
                <div class="info-item">
                    <!-- ä¸¾åŠåœ°ç‚¹å›¾æ ‡ -->
                    <div class="info-icon">ğŸ¨</div>
                    <!-- ä¸¾åŠåœ°ç‚¹æ–‡å­—ä¿¡æ¯ -->
                    <div class="info-text">
                        <h3>ä¸¾åŠåœ°ç‚¹</h3>
                        <!-- åŠ¨æ€æ˜¾ç¤ºå©šç¤¼ä¸¾åŠåœ°ç‚¹ -->
                        <p>{{ wedding_event.venue }}</p>
                    </div>
                </div>

                <!-- è¯¦ç»†åœ°å€ä¿¡æ¯é¡¹ -->
                <div class="info-item">
                    <!-- è¯¦ç»†åœ°å€å›¾æ ‡ -->
                    <div class="info-icon">ğŸ“</div>
                    <!-- è¯¦ç»†åœ°å€æ–‡å­—ä¿¡æ¯ -->
                    <div class="info-text">
                        <h3>è¯¦ç»†åœ°å€</h3>
                        <!-- åŠ¨æ€æ˜¾ç¤ºå©šç¤¼è¯¦ç»†åœ°å€ -->
                        <p>{{ wedding_event.address }}</p>
                    </div>
                </div>
                
                <!-- æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–åˆ°åœ°ç†ç¼–ç ä¿¡æ¯ -->
                {% if map_config.coordinates_found and map_config.geocoding_details %}
                <!-- åœ°ç†ç¼–ç ä¿¡æ¯é¡¹ -->
                <div class="info-item">
                    <!-- åœ°ç†ç¼–ç ä¿¡æ¯å›¾æ ‡ -->
                    <div class="info-icon">ğŸ”</div>
                    <!-- åœ°ç†ç¼–ç è¯¦ç»†ä¿¡æ¯ -->
                    <div class="info-text">
                        <h3>åœ°ç†ç¼–ç ä¿¡æ¯</h3>
                        <!-- æ˜¾ç¤ºåœ°ç†ç¼–ç åŒ¹é…çº§åˆ«ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™æ˜¾ç¤ºé»˜è®¤å€¼â€œæœªçŸ¥â€ -->
                        <p>åŒ¹é…çº§åˆ«: {{ map_config.geocoding_details.level|default:"æœªçŸ¥" }}</p>
                        <!-- æ˜¾ç¤ºåœ°ç†ç¼–ç åŒ¹é…ç½®ä¿¡åº¦ -->
                        <p>ç½®ä¿¡åº¦: 
                            <!-- æ ¹æ®ç½®ä¿¡åº¦æ•°å€¼æ˜¾ç¤ºä¸åŒçš„ç½®ä¿¡åº¦æ ‡ç­¾ -->
                            {% if map_config.confidence == 5 %}
                                <!-- é«˜ç½®ä¿¡åº¦ï¼ˆ5ï¼‰æ˜¾ç¤ºâ€œå¾ˆé«˜â€æ ‡ç­¾ -->
                                <span class="high-confidence">å¾ˆé«˜</span>
                            {% elif map_config.confidence == 4 %}
                                <!-- é«˜ç½®ä¿¡åº¦ï¼ˆ4ï¼‰æ˜¾ç¤ºâ€œé«˜â€æ ‡ç­¾ -->
                                <span class="high-confidence">é«˜</span>
                            {% elif map_config.confidence == 3 %}
                                <!-- ä¸­ç­‰ç½®ä¿¡åº¦ï¼ˆ3ï¼‰æ˜¾ç¤ºâ€œä¸­â€æ ‡ç­¾ -->
                                <span class="medium-confidence">ä¸­</span>
                            {% elif map_config.confidence >= 1 %}
                                <!-- ä½ç½®ä¿¡åº¦ï¼ˆ1-2ï¼‰æ˜¾ç¤ºâ€œä½â€æ ‡ç­¾ -->
                                <span class="low-confidence">ä½</span>
                            {% else %}
                                <!-- æœªçŸ¥ç½®ä¿¡åº¦ï¼ˆ0æˆ–è´Ÿæ•°ï¼‰æ˜¾ç¤ºâ€œæœªçŸ¥â€æ ‡ç­¾ -->
                                <span class="unknown-confidence">æœªçŸ¥</span>
                            {% endif %}
                        </p>
                        <!-- å¦‚æœå­˜åœ¨çœä»½ä¿¡æ¯ï¼Œåˆ™æ˜¾ç¤ºçœä»½ -->
                        {% if map_config.geocoding_details.province %}
                        <p>çœä»½: {{ map_config.geocoding_details.province }}</p>
                        {% endif %}
                        <!-- å¦‚æœå­˜åœ¨åŸå¸‚ä¿¡æ¯ï¼Œåˆ™æ˜¾ç¤ºåŸå¸‚ -->
                        {% if map_config.geocoding_details.city %}
                        <p>åŸå¸‚: {{ map_config.geocoding_details.city }}</p>
                        {% endif %}
                        <!-- å¦‚æœå­˜åœ¨åŒºåŸŸä¿¡æ¯ï¼Œåˆ™æ˜¾ç¤ºåŒºåŸŸ -->
                        {% if map_config.geocoding_details.district %}
                        <p>åŒºåŸŸ: {{ map_config.geocoding_details.district }}</p>
                        {% endif %}
                    </div>
                </div>
                <!-- å¦‚æœæœªæ‰¾åˆ°åœ°ç†ç¼–ç ä¿¡æ¯ä½†å­˜åœ¨åœ°å€ï¼Œåˆ™æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ -->
                {% elif wedding_event.address %}
                <!-- åœ°ç†ç¼–ç çŠ¶æ€ä¿¡æ¯é¡¹ -->
                <div class="info-item">
                    <!-- åœ°ç†ç¼–ç çŠ¶æ€å›¾æ ‡ -->
                    <div class="info-icon">âš ï¸</div>
                    <!-- åœ°ç†ç¼–ç çŠ¶æ€æ–‡å­—ä¿¡æ¯ -->
                    <div class="info-text">
                        <h3>åœ°ç†ç¼–ç çŠ¶æ€</h3>
                        <!-- æç¤ºç”¨æˆ·åœ°å€æ ¼å¼å¯èƒ½å­˜åœ¨é—®é¢˜ -->
                        <p>æœªèƒ½è·å–ç²¾ç¡®åæ ‡ï¼Œè¯·æ£€æŸ¥åœ°å€æ ¼å¼æ˜¯å¦æ­£ç¡®</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        <!-- å¦‚æœä¸å­˜åœ¨å©šç¤¼äº‹ä»¶ä¿¡æ¯ï¼Œåˆ™æ˜¾ç¤ºæç¤ºä¿¡æ¯ -->
        {% else %}
        <!-- ä½ç½®ä¿¡æ¯å¡ç‰‡ -->
        <div class="location-card">
            <p>å©šç¤¼ä¿¡æ¯æš‚æœªè®¾ç½®</p>
        </div>
        {% endif %}

        <!-- è¿”å›é¦–é¡µæŒ‰é’®å®¹å™¨ -->
        <div style="text-align: center; margin-top: 30px;">
            <!-- è¿”å›é¦–é¡µé“¾æ¥ï¼Œç‚¹å‡»åè·³è½¬åˆ°ä¸»é¡µ -->
            <a href="/" class="back-home">â† è¿”å›é¦–é¡µ</a>
        </div>
    </div>

    <!-- é«˜å¾·åœ°å›¾å®‰å…¨å¯†é’¥é…ç½®ï¼ˆå¦‚æœè®¾ç½®äº†å®‰å…¨å¯†é’¥ï¼‰ -->
    <!-- é…ç½®é«˜å¾·åœ°å›¾çš„å®‰å…¨å¯†é’¥ï¼Œç”¨äºä¿æŠ¤APIè°ƒç”¨å®‰å…¨ -->
    {% if amap_security_js_code %}
    <!-- å¦‚æœå­˜åœ¨å®‰å…¨å¯†é’¥ï¼Œåˆ™åœ¨å®¢æˆ·ç«¯é…ç½®å®‰å…¨è®¾ç½® -->
    <script type="text/javascript">
        // é«˜å¾·åœ°å›¾å®‰å…¨é…ç½®å¯¹è±¡ï¼Œç”¨äºè®¾ç½®å®‰å…¨å¯†é’¥
        window._AMapSecurityConfig = {
            // è®¾ç½®å®‰å…¨å¯†é’¥ï¼Œç”¨äºéªŒè¯APIè°ƒç”¨çš„åˆæ³•æ€§
            securityJsCode: '{{ amap_security_js_code }}'
        }
    </script>
    <!-- ç»“æŸå®‰å…¨å¯†é’¥é…ç½®æ¡ä»¶åˆ¤æ–­ -->
    {% endif %}

    <!-- é«˜å¾·åœ°å›¾JS API 2.0 -->
    <!-- åœ°å›¾åˆå§‹åŒ–å’Œé…ç½®è„šæœ¬ -->
    <script type="text/javascript">
        // åˆå§‹åŒ–åœ°å›¾çš„ä¸»å‡½æ•°
        // ä»åç«¯è·å–åœ°å›¾é…ç½®ä¿¡æ¯å¹¶åˆå§‹åŒ–é«˜å¾·åœ°å›¾ç»„ä»¶
        function initMap() {
            // é€šè¿‡fetch APIä»åç«¯è·å–åœ°å›¾é…ç½®
            // è¯·æ±‚/api/map-config/ç«¯ç‚¹è·å–åœ°å›¾æ‰€éœ€çš„é…ç½®ä¿¡æ¯
            fetch('/api/map-config/')
                // å°†å“åº”è½¬æ¢ä¸ºJSONæ ¼å¼
                .then(response => response.json())
                // å¤„ç†JSONå“åº”æ•°æ®
                .then(data => {
                    // æ£€æŸ¥APIè°ƒç”¨æ˜¯å¦æˆåŠŸ
                    if (data.success) {
                        // ä»å“åº”æ•°æ®ä¸­æå–åœ°å›¾é…ç½®
                        var mapConfig = data.map_config;
                        // ä½¿ç”¨è·å–åˆ°çš„é…ç½®åˆå§‹åŒ–åœ°å›¾
                        initializeMap(mapConfig);
                    } else {
                        // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œåœ¨æ§åˆ¶å°è®°å½•é”™è¯¯ä¿¡æ¯
                        console.error('è·å–åœ°å›¾é…ç½®å¤±è´¥:', data.message);
                        // ä½¿ç”¨é»˜è®¤é…ç½®åˆå§‹åŒ–åœ°å›¾
                        var defaultConfig = {
                            // é»˜è®¤ä¸­å¿ƒçº¬åº¦ï¼ˆåŒ—äº¬å¤©å®‰é—¨ï¼‰
                            centerLat: 39.9042,
                            // é»˜è®¤ä¸­å¿ƒç»åº¦ï¼ˆåŒ—äº¬å¤©å®‰é—¨ï¼‰
                            centerLng: 116.4074,
                            // é»˜è®¤ç¼©æ”¾çº§åˆ«
                            zoom: 12,
                            // æ ‡è®°ç‚¹æ ‡é¢˜
                            markerTitle: 'å©šç¤¼åœ°ç‚¹',
                            // æ ‡è®°ç‚¹å†…å®¹
                            markerContent: 'åœ°å›¾é…ç½®åŠ è½½å¤±è´¥',
                            // åæ ‡æ˜¯å¦æ‰¾åˆ°çš„æ ‡å¿—
                            coordinatesFound: false,
                            // åŒ¹é…ç½®ä¿¡åº¦
                            confidence: 0,
                            // åœ°ç†ç¼–ç è¯¦ç»†ä¿¡æ¯
                            geocodingDetails: {}
                        };
                        // ä½¿ç”¨é»˜è®¤é…ç½®åˆå§‹åŒ–åœ°å›¾
                        initializeMap(defaultConfig);
                    }
                })
                // æ•è·å¹¶å¤„ç†ç½‘ç»œè¯·æ±‚é”™è¯¯
                .catch(error => {
                    // åœ¨æ§åˆ¶å°è®°å½•ç½‘ç»œé”™è¯¯ä¿¡æ¯
                    console.error('è·å–åœ°å›¾é…ç½®æ—¶å‡ºé”™:', error);
                    // ä½¿ç”¨é»˜è®¤é…ç½®åˆå§‹åŒ–åœ°å›¾
                    var defaultConfig = {
                        // é»˜è®¤ä¸­å¿ƒçº¬åº¦ï¼ˆåŒ—äº¬å¤©å®‰é—¨ï¼‰
                        centerLat: 39.9042,
                        // é»˜è®¤ä¸­å¿ƒç»åº¦ï¼ˆåŒ—äº¬å¤©å®‰é—¨ï¼‰
                        centerLng: 116.4074,
                        // é»˜è®¤ç¼©æ”¾çº§åˆ«
                        zoom: 12,
                        // æ ‡è®°ç‚¹æ ‡é¢˜
                        markerTitle: 'å©šç¤¼åœ°ç‚¹',
                        // æ ‡è®°ç‚¹å†…å®¹
                        markerContent: 'ç½‘ç»œé”™è¯¯ï¼Œåœ°å›¾é…ç½®åŠ è½½å¤±è´¥',
                        // åæ ‡æ˜¯å¦æ‰¾åˆ°çš„æ ‡å¿—
                        coordinatesFound: false,
                        // åŒ¹é…ç½®ä¿¡åº¦
                        confidence: 0,
                        // åœ°ç†ç¼–ç è¯¦ç»†ä¿¡æ¯
                        geocodingDetails: {}
                    };
                    // ä½¿ç”¨é»˜è®¤é…ç½®åˆå§‹åŒ–åœ°å›¾
                    initializeMap(defaultConfig);
                });
        }
        
        // åˆå§‹åŒ–åœ°å›¾çš„å…·ä½“å®ç°å‡½æ•°
        // æ¥æ”¶åœ°å›¾é…ç½®å‚æ•°å¹¶åˆ›å»ºé«˜å¾·åœ°å›¾å®ä¾‹
        function initializeMap(mapConfig) {
            // ç¡®ä¿åœ°å›¾å®¹å™¨DOMå…ƒç´ å­˜åœ¨å¹¶å¯è§
            // è·å–åœ°å›¾å®¹å™¨å…ƒç´ 
            const mapContainer = document.getElementById('amap-container');
            // è·å–åœ°å›¾åŠ è½½æç¤ºå…ƒç´ 
            const loadingElement = document.getElementById('map-loading');

            // æ£€æŸ¥åœ°å›¾å®¹å™¨æ˜¯å¦å­˜åœ¨
            if (!mapContainer) {
                // å¦‚æœåœ°å›¾å®¹å™¨ä¸å­˜åœ¨ï¼Œåœ¨æ§åˆ¶å°è®°å½•é”™è¯¯
                console.error('åœ°å›¾å®¹å™¨æœªæ‰¾åˆ°');
                // å¦‚æœåŠ è½½æç¤ºå…ƒç´ å­˜åœ¨ï¼Œæ›´æ–°å…¶å†…å®¹
                if (loadingElement) {
                    loadingElement.innerHTML = '<p>åœ°å›¾å®¹å™¨æœªæ‰¾åˆ°</p>';
                }
                // ç»ˆæ­¢å‡½æ•°æ‰§è¡Œ
                return;
            }

            // éªŒè¯å¹¶å¤„ç†åæ ‡æœ‰æ•ˆæ€§ï¼Œç„¶ååˆå§‹åŒ–åœ°å›¾
            // è®¾ç½®é»˜è®¤ä¸­å¿ƒåæ ‡ï¼ˆåŒ—äº¬å¤©å®‰é—¨ï¼‰
            let validCenter = [116.4074, 39.9042];
            // è®¾ç½®é»˜è®¤ç¼©æ”¾çº§åˆ«
            let validZoom = 12;
            
            // æ£€æŸ¥åœ°å›¾é…ç½®ä¸­çš„åæ ‡æ˜¯å¦æœ‰æ•ˆ
            if (mapConfig.center_lat && mapConfig.center_lng && 
                !isNaN(parseFloat(mapConfig.center_lat)) && 
                !isNaN(parseFloat(mapConfig.center_lng))) {
                // å¦‚æœåæ ‡æœ‰æ•ˆï¼Œä½¿ç”¨é…ç½®ä¸­çš„åæ ‡
                validCenter = [parseFloat(mapConfig.center_lng), parseFloat(mapConfig.center_lat)];
                // ä½¿ç”¨é…ç½®ä¸­çš„ç¼©æ”¾çº§åˆ«ï¼Œå¦‚æœæœªè®¾ç½®åˆ™ä½¿ç”¨é»˜è®¤å€¼
                validZoom = mapConfig.zoom || 12;
            } else {
                // å¦‚æœåæ ‡æ— æ•ˆï¼Œåœ¨æ§åˆ¶å°è®°å½•è­¦å‘Šä¿¡æ¯
                console.warn('ä½¿ç”¨é»˜è®¤åæ ‡åˆå§‹åŒ–åœ°å›¾');
            }
            
            // åˆ›å»ºé«˜å¾·åœ°å›¾å®ä¾‹
            const map = new AMap.Map('amap-container', {
                // è®¾ç½®åœ°å›¾ç¼©æ”¾çº§åˆ«
                zoom: validZoom,
                // è®¾ç½®åœ°å›¾ä¸­å¿ƒç‚¹åæ ‡
                center: validCenter,
                // è®¾ç½®åœ°å›¾æ ·å¼ä¸ºæ™®é€šæ ·å¼ï¼ŒåŒ…å«å®Œæ•´åœ°å›¾ä¿¡æ¯
                mapStyle: 'amap://styles/normal',
                // è®¾ç½®è§†å›¾æ¨¡å¼ä¸º2D
                viewMode: '2D',
                // å¯ç”¨åœ°å›¾è‡ªé€‚åº”çª—å£å¤§å°å˜åŒ–
                resizeEnable: true,
                // æ˜¾ç¤ºåœ°å›¾æ ‡ç­¾ï¼ˆåŒ…æ‹¬é“è·¯åç§°ã€å»ºç­‘ç‰©åç§°ç­‰ï¼‰
                showLabel: true,
                // å…è®¸ç¼©æ”¾çº§åˆ«è¶…å‡ºé»˜è®¤èŒƒå›´
                expandZoomRange: true
            });

            // åŠ è½½å¹¶æ·»åŠ åœ°å›¾æ§ä»¶å’Œå›¾å±‚
            // åŠ è½½æ‰€éœ€çš„æ’ä»¶å¹¶åˆå§‹åŒ–
            AMap.plugin(['AMap.ToolBar', 'AMap.Scale', 'AMap.HawkEye', 'AMap.TileLayer.RoadNet', 'AMap.Buildings'], function() {
                try {
                    // æ·»åŠ æ¯”ä¾‹å°ºæ§ä»¶ï¼Œæ˜¾ç¤ºå½“å‰åœ°å›¾çš„æ¯”ä¾‹å°º
                    map.addControl(new AMap.Scale());

                    // æ·»åŠ é¹°çœ¼å›¾æ§ä»¶ï¼Œæä¾›å…¨å±€åœ°å›¾æ¦‚è§ˆ
                    map.addControl(new AMap.HawkEye({isOpen: true, size: new AMap.Size(150, 112)}));

                    // æ·»åŠ å·¥å…·æ æ§ä»¶ï¼Œæä¾›åœ°å›¾æ“ä½œæŒ‰é’®
                    map.addControl(new AMap.ToolBar());

                    // æ·»åŠ è·¯ç½‘å›¾å±‚ï¼Œç¡®ä¿æ˜¾ç¤ºé“è·¯åç§°å’Œå…¶ä»–é“è·¯ç›¸å…³ä¿¡æ¯
                    var roadNetLayer = new AMap.TileLayer.RoadNet({
                        // è®¾ç½®å›¾å±‚é€‚ç”¨çš„ç¼©æ”¾çº§åˆ«èŒƒå›´
                        zooms: [4, 20],
                        // è®¾ç½®å›¾å±‚é€æ˜åº¦
                        opacity: 1,
                        // è®¾ç½®å›¾å±‚å±‚çº§
                        zIndex: 9
                    });
                    // å°†è·¯ç½‘å›¾å±‚æ·»åŠ åˆ°åœ°å›¾
                    map.add(roadNetLayer);

                    // æ·»åŠ å»ºç­‘ç‰©å›¾å±‚ï¼Œæ˜¾ç¤ºå»ºç­‘ç‰©çš„ç«‹ä½“æ•ˆæœ
                    var buildings = new AMap.Buildings({
                        // è®¾ç½®å»ºç­‘ç‰©å›¾å±‚é€‚ç”¨çš„ç¼©æ”¾çº§åˆ«èŒƒå›´
                        zooms: [14, 20],
                        // è®¾ç½®å»ºç­‘ç‰©é«˜åº¦ç³»æ•°
                        heightFactor: 1.2,
                        // è®¾ç½®å»ºç­‘ç‰©å¢™ä½“é¢œè‰²
                        wallColor: 'rgb(166, 226, 255)',
                        // è®¾ç½®å»ºç­‘ç‰©å±‹é¡¶é¢œè‰²
                        roofColor: 'rgb(220, 231, 255)'
                    });
                    // å°†å»ºç­‘ç‰©å›¾å±‚æ·»åŠ åˆ°åœ°å›¾
                    map.add(buildings);

                    // è®¾ç½®åœ°å›¾æ˜¾ç¤ºè¦ç´ ï¼Œç¡®ä¿æ˜¾ç¤ºå®Œæ•´çš„åœ°å›¾ä¿¡æ¯
                    map.setFeatures(['bg', 'road', 'building', 'point', 'label']);

                } catch (e) {
                    // å¦‚æœæ·»åŠ æ§ä»¶æˆ–å›¾å±‚å¤±è´¥ï¼Œåœ¨æ§åˆ¶å°è®°å½•é”™è¯¯
                    console.error('æ·»åŠ åœ°å›¾æ§ä»¶æˆ–å›¾å±‚å¤±è´¥:', e);
                }
            });

            // ç›‘å¬åœ°å›¾åŠ è½½å®Œæˆäº‹ä»¶ï¼Œåœ¨åœ°å›¾å®Œå…¨åŠ è½½åæ·»åŠ æ ‡è®°ç‚¹å’Œä¿¡æ¯çª—ä½“
            map.on('complete', function() {
                // æ£€æŸ¥åæ ‡æœ‰æ•ˆæ€§åå†æ·»åŠ æ ‡è®°ç‚¹
                if (mapConfig.center_lat && mapConfig.center_lng && 
                    !isNaN(parseFloat(mapConfig.center_lat)) && 
                    !isNaN(parseFloat(mapConfig.center_lng))) {
                    
                    // åˆ›å»ºæ ‡è®°ç‚¹å®ä¾‹
                    const marker = new AMap.Marker({
                        // è®¾ç½®æ ‡è®°ç‚¹ä½ç½®åæ ‡
                        position: [parseFloat(mapConfig.center_lng), parseFloat(mapConfig.center_lat)],
                        // è®¾ç½®æ ‡è®°ç‚¹æ ‡é¢˜
                        title: mapConfig.marker_title,
                        // è®¾ç½®æ ‡è®°ç‚¹æ ‡ç­¾
                        label: {
                            // è®¾ç½®æ ‡ç­¾å†…å®¹
                            content: mapConfig.marker_title,
                            // è®¾ç½®æ ‡ç­¾åç§»é‡
                            offset: new AMap.Pixel(0, -20)
                        }
                    });
                    // å°†æ ‡è®°ç‚¹æ·»åŠ åˆ°åœ°å›¾
                    map.add(marker);
                    
                    // æ·»åŠ ä¿¡æ¯çª—ä½“ï¼Œæ˜¾ç¤ºæ ‡è®°ç‚¹çš„è¯¦ç»†ä¿¡æ¯
                    if (mapConfig.marker_content) {
                        // åˆå§‹åŒ–ä¿¡æ¯çª—ä½“HTMLå†…å®¹
                        let contentHtml = `<div style="padding: 10px; max-width: 300px;">`;
                        // æ·»åŠ æ ‡é¢˜
                        contentHtml += `<strong>${mapConfig.marker_title}</strong><br/>`;
                        // æ·»åŠ å†…å®¹
                        contentHtml += `${mapConfig.marker_content}<br/>`;
                        
                        // å¦‚æœæœ‰åœ°ç†ç¼–ç è¯¦ç»†ä¿¡æ¯ï¼Œæ˜¾ç¤ºåŒ¹é…ç½®ä¿¡åº¦
                        if (mapConfig.coordinates_found && mapConfig.confidence > 0) {
                            // åˆå§‹åŒ–ç½®ä¿¡åº¦æ–‡æœ¬
                            let confidenceText = '';
                            // åˆå§‹åŒ–ç½®ä¿¡åº¦CSSç±»
                            let confidenceClass = '';
                            
                            // æ ¹æ®ç½®ä¿¡åº¦æ•°å€¼è®¾ç½®å¯¹åº”çš„æ–‡æœ¬å’ŒCSSç±»
                            switch(mapConfig.confidence) {
                                // ä½ç½®ä¿¡åº¦ï¼ˆ1-2ï¼‰
                                case 1:
                                case 2:
                                    confidenceText = 'ä½';
                                    confidenceClass = 'low-confidence';
                                    break;
                                // ä¸­ç½®ä¿¡åº¦ï¼ˆ3ï¼‰
                                case 3:
                                    confidenceText = 'ä¸­';
                                    confidenceClass = 'medium-confidence';
                                    break;
                                // é«˜ç½®ä¿¡åº¦ï¼ˆ4-5ï¼‰
                                case 4:
                                case 5:
                                    confidenceText = 'é«˜';
                                    confidenceClass = 'high-confidence';
                                    break;
                                // é»˜è®¤æƒ…å†µï¼ˆå…¶ä»–å€¼ï¼‰
                                default:
                                    confidenceText = 'æœªçŸ¥';
                                    confidenceClass = 'unknown-confidence';
                            }
                            
                            // æ·»åŠ ç½®ä¿¡åº¦ä¿¡æ¯åˆ°HTMLå†…å®¹
                            contentHtml += `<small class="confidence-info ${confidenceClass}">åŒ¹é…ç½®ä¿¡åº¦: ${confidenceText}</small>`;
                        }
                        
                        // ç»“æŸHTMLå†…å®¹
                        contentHtml += `</div>`;
                        
                        // æ£€æŸ¥æ ‡è®°ç‚¹åæ ‡æœ‰æ•ˆæ€§åå†åˆ›å»ºä¿¡æ¯çª—ä½“
                        const markerPosition = marker.getPosition();
                        if (markerPosition && !isNaN(markerPosition.lat) && !isNaN(markerPosition.lng)) {
                            // åˆ›å»ºä¿¡æ¯çª—ä½“å®ä¾‹
                            const infoWindow = new AMap.InfoWindow({
                                // è®¾ç½®ä¿¡æ¯çª—ä½“å†…å®¹
                                content: contentHtml,
                                // è®¾ç½®ä¿¡æ¯çª—ä½“åç§»é‡
                                offset: new AMap.Pixel(0, -30)
                            });
                            // åœ¨åœ°å›¾ä¸Šæ‰“å¼€ä¿¡æ¯çª—ä½“
                            infoWindow.open(map, markerPosition);
                        } else {
                            // å¦‚æœæ ‡è®°ç‚¹ä½ç½®æ— æ•ˆï¼Œåœ¨æ§åˆ¶å°è®°å½•è­¦å‘Š
                            console.warn('æ— æ•ˆçš„æ ‡è®°ä½ç½®ï¼Œè·³è¿‡ä¿¡æ¯çª—ä½“åˆ›å»º');
                        }
                    }
                } else {
                    // å¦‚æœé…ç½®ä¸­çš„åæ ‡æ— æ•ˆï¼Œåœ¨æ§åˆ¶å°è®°å½•è­¦å‘Š
                    console.warn('æ— æ•ˆçš„åæ ‡ï¼Œè·³è¿‡æ ‡è®°ç‚¹åˆ›å»º');
                    // ä½¿ç”¨é»˜è®¤åæ ‡ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆåˆ›å»ºæ ‡è®°ç‚¹
                    const defaultMarker = new AMap.Marker({
                        // ä½¿ç”¨é»˜è®¤åæ ‡ï¼ˆåŒ—äº¬å¤©å®‰é—¨ï¼‰
                        position: [116.4074, 39.9042],
                        // ä½¿ç”¨é…ç½®ä¸­çš„æ ‡é¢˜æˆ–é»˜è®¤æ ‡é¢˜
                        title: mapConfig.marker_title || 'å©šç¤¼åœ°ç‚¹',
                        // è®¾ç½®æ ‡è®°ç‚¹æ ‡ç­¾
                        label: {
                            // ä½¿ç”¨é…ç½®ä¸­çš„æ ‡é¢˜æˆ–é»˜è®¤æ ‡é¢˜
                            content: mapConfig.marker_title || 'å©šç¤¼åœ°ç‚¹',
                            // è®¾ç½®æ ‡ç­¾åç§»é‡
                            offset: new AMap.Pixel(0, -20)
                        }
                    });
                    // å°†é»˜è®¤æ ‡è®°ç‚¹æ·»åŠ åˆ°åœ°å›¾
                    map.add(defaultMarker);
                    
                    // ä¸ºé»˜è®¤æ ‡è®°ç‚¹æ·»åŠ ä¿¡æ¯çª—ä½“
                    if (mapConfig.marker_content) {
                        // åˆå§‹åŒ–ä¿¡æ¯çª—ä½“HTMLå†…å®¹
                        let contentHtml = `<div style="padding: 10px; max-width: 300px;">`;
                        // æ·»åŠ æ ‡é¢˜
                        contentHtml += `<strong>${mapConfig.marker_title || 'å©šç¤¼åœ°ç‚¹'}</strong><br/>`;
                        // æ·»åŠ å†…å®¹
                        contentHtml += `${mapConfig.marker_content}<br/>`;
                        
                        // ç»“æŸHTMLå†…å®¹
                        contentHtml += `</div>`;
                        
                        // åˆ›å»ºä¿¡æ¯çª—ä½“å®ä¾‹
                        const infoWindow = new AMap.InfoWindow({
                            // è®¾ç½®ä¿¡æ¯çª—ä½“å†…å®¹
                            content: contentHtml,
                            // è®¾ç½®ä¿¡æ¯çª—ä½“åç§»é‡
                            offset: new AMap.Pixel(0, -30)
                        });
                        // åœ¨åœ°å›¾ä¸Šæ‰“å¼€ä¿¡æ¯çª—ä½“
                        infoWindow.open(map, [116.4074, 39.9042]);
                    }
                }
                
                // åœ°å›¾åŠ è½½å®Œæˆåéšè—åŠ è½½æç¤º
                console.log('åœ°å›¾åŠ è½½å®Œæˆ');
                // å¦‚æœåŠ è½½æç¤ºå…ƒç´ å­˜åœ¨ï¼Œéšè—å®ƒ
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
            });

            // ç›‘å¬åœ°å›¾åŠ è½½é”™è¯¯äº‹ä»¶ï¼Œå¤„ç†åœ°å›¾åŠ è½½å¤±è´¥çš„æƒ…å†µ
            map.on('error', function(err) {
                // åœ¨æ§åˆ¶å°è®°å½•åœ°å›¾åŠ è½½é”™è¯¯
                console.error('åœ°å›¾åŠ è½½é”™è¯¯:', err);
                // å¦‚æœåŠ è½½æç¤ºå…ƒç´ å­˜åœ¨ï¼Œæ›´æ–°å…¶å†…å®¹ä¸ºé”™è¯¯ä¿¡æ¯
                if (loadingElement) {
                    loadingElement.innerHTML = '<p>åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>';
                }
            });
        }
    </script>

    <!-- åŠ è½½é«˜å¾·åœ°å›¾API -->
    <!-- åŠ¨æ€åŠ è½½é«˜å¾·åœ°å›¾APIè„šæœ¬ -->
    <script type="text/javascript">
        // åŠ¨æ€åŠ è½½é«˜å¾·åœ°å›¾APIçš„å‡½æ•°
        // æ£€æŸ¥APIæ˜¯å¦å·²åŠ è½½ï¼Œå¦‚æœæœªåŠ è½½åˆ™ä»æœåŠ¡å™¨è·å–é…ç½®å¹¶åŠ è½½API
        function loadAMapAPI() {
            // æ£€æŸ¥é«˜å¾·åœ°å›¾APIæ˜¯å¦å·²ç»åŠ è½½
            // é€šè¿‡æ£€æµ‹å…¨å±€å˜é‡AMapæ˜¯å¦å­˜åœ¨æ¥åˆ¤æ–­
            if (typeof AMap !== 'undefined') {
                // å¦‚æœAPIå·²åŠ è½½ï¼Œç›´æ¥è°ƒç”¨åœ°å›¾åˆå§‹åŒ–å‡½æ•°
                initMap();
                // ç»ˆæ­¢å‡½æ•°æ‰§è¡Œ
                return;
            }
                
            // ä»åç«¯è·å–é…ç½®ä¿¡æ¯ä»¥è·å–APIå¯†é’¥
            // å‘èµ·fetchè¯·æ±‚è·å–åœ°å›¾é…ç½®å’ŒAPIå¯†é’¥
            fetch('/api/map-config/')
                // å°†å“åº”è½¬æ¢ä¸ºJSONæ ¼å¼
                .then(response => response.json())
                // å¤„ç†JSONå“åº”æ•°æ®
                .then(data => {
                    // æ£€æŸ¥APIè°ƒç”¨æ˜¯å¦æˆåŠŸ
                    if (data.success) {
                        // åŠ¨æ€åˆ›å»ºscriptæ ‡ç­¾ç”¨äºåŠ è½½é«˜å¾·åœ°å›¾API
                        var script = document.createElement('script');
                        // è®¾ç½®è„šæœ¬ç±»å‹ä¸ºJavaScript
                        script.type = 'text/javascript';
                        // ä»åç«¯å“åº”ä¸­è·å–APIå¯†é’¥ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä»æ¨¡æ¿å˜é‡è·å–
                        var jsApiKey = data.js_api_key || '{{ amap_api_key|default:"" }}';
                        // æ£€æŸ¥æ˜¯å¦è·å–åˆ°æœ‰æ•ˆçš„APIå¯†é’¥
                        if (!jsApiKey) {
                            // å¦‚æœæ²¡æœ‰APIå¯†é’¥ï¼Œåœ¨æ§åˆ¶å°è®°å½•é”™è¯¯
                            console.error('æœªé…ç½®é«˜å¾·åœ°å›¾APIå¯†é’¥ï¼Œè¯·åœ¨settings.pyä¸­è®¾ç½®AMAP_JS_API_KEY');
                            // è·å–åŠ è½½æç¤ºå…ƒç´ 
                            const loadingElement = document.getElementById('map-loading');
                            // å¦‚æœåŠ è½½æç¤ºå…ƒç´ å­˜åœ¨ï¼Œæ›´æ–°å…¶å†…å®¹
                            if (loadingElement) {
                                loadingElement.innerHTML = '<p>æœªé…ç½®APIå¯†é’¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜</p>'; 
                            }
                            // ç»ˆæ­¢å‡½æ•°æ‰§è¡Œ
                            return;
                        }
                        // è®¾ç½®è„šæœ¬æºURLï¼ŒåŒ…å«APIå¯†é’¥å’Œå›è°ƒå‡½æ•°
                        script.src = 'https://webapi.amap.com/maps?v=2.0&key=' + jsApiKey + '&callback=initMap';
                        // è®¾ç½®è„šæœ¬åŠ è½½é”™è¯¯å¤„ç†å‡½æ•°
                        script.onerror = function() {
                            // åœ¨æ§åˆ¶å°è®°å½•APIåŠ è½½å¤±è´¥é”™è¯¯
                            console.error('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥');
                            // è·å–åŠ è½½æç¤ºå…ƒç´ 
                            const loadingElement = document.getElementById('map-loading');
                            // å¦‚æœåŠ è½½æç¤ºå…ƒç´ å­˜åœ¨ï¼Œæ›´æ–°å…¶å†…å®¹ä¸ºé”™è¯¯ä¿¡æ¯
                            if (loadingElement) {
                                loadingElement.innerHTML = '<p>åœ°å›¾APIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–APIå¯†é’¥é…ç½®</p>'; 
                            }
                        };
                        // å°†è„šæœ¬æ ‡ç­¾æ·»åŠ åˆ°é¡µé¢å¤´éƒ¨ï¼Œå¼€å§‹åŠ è½½API
                        document.head.appendChild(script);
                    } else {
                        // å¦‚æœæ— æ³•è·å–åœ°å›¾é…ç½®ï¼Œåœ¨æ§åˆ¶å°è®°å½•é”™è¯¯
                        console.error('æ— æ³•è·å–åœ°å›¾é…ç½®:', data.message);
                        // è·å–åŠ è½½æç¤ºå…ƒç´ 
                        const loadingElement = document.getElementById('map-loading');
                        // å¦‚æœåŠ è½½æç¤ºå…ƒç´ å­˜åœ¨ï¼Œæ›´æ–°å…¶å†…å®¹
                        if (loadingElement) {
                            loadingElement.innerHTML = '<p>æ— æ³•è·å–åœ°å›¾é…ç½®ä¿¡æ¯</p>'; 
                        }
                    }
                })
                // æ•è·å¹¶å¤„ç†ç½‘ç»œè¯·æ±‚é”™è¯¯
                .catch(error => {
                    // åœ¨æ§åˆ¶å°è®°å½•è·å–é…ç½®æ—¶çš„é”™è¯¯
                    console.error('è·å–åœ°å›¾é…ç½®æ—¶å‡ºé”™:', error);
                    // è·å–åŠ è½½æç¤ºå…ƒç´ 
                    const loadingElement = document.getElementById('map-loading');
                    // å¦‚æœåŠ è½½æç¤ºå…ƒç´ å­˜åœ¨ï¼Œæ›´æ–°å…¶å†…å®¹
                    if (loadingElement) {
                        loadingElement.innerHTML = '<p>è·å–åœ°å›¾é…ç½®æ—¶å‡ºé”™</p>'; 
                    }
                });
        }
            
        // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½åœ°å›¾API
        // æ£€æŸ¥æ–‡æ¡£æ˜¯å¦ä»åœ¨åŠ è½½çŠ¶æ€
        if (document.readyState === 'loading') {
            // å¦‚æœæ–‡æ¡£ä»åœ¨åŠ è½½ï¼Œç­‰å¾…DOMå†…å®¹åŠ è½½å®Œæˆåå†åŠ è½½API
            document.addEventListener('DOMContentLoaded', loadAMapAPI);
        } else {
            // å¦‚æœæ–‡æ¡£å·²å®ŒæˆåŠ è½½ï¼Œç›´æ¥åŠ è½½API
            loadAMapAPI();
        }
    </script>
</body>
</html>